# 2026-02-16 (Monday)

## Power Outage Recovery
- Power outage brought down infra overnight/morning. GitLab returning 502s from ~1:30 AM through afternoon.
- Telegraf IPMI data stopped at 1:12 AM EST — caused DatasourceNoData Grafana alert for CPU Temps.
- Telegraf is a host systemd service, NOT a Docker container — doesn't log to Loki.

## Promtail Journal Scraping BROKEN
- Discovered systemd journal logs have NEVER been reaching Loki.
- Promtail mounts `/run/log/journal` (volatile, RAM-only, wiped on reboot).
- On persistent journaling systems, logs live at `/var/log/journal` instead.
- Only `scrub-transcripts` and `vault-audit` jobs exist in Loki — no `systemd-journal` job.
- Fix: mount `/var/log/journal` in docker-compose + update Promtail config path.

## MEMORY.md Fix — GITLAB_TOKEN
- MEMORY.md still said `$GITLAB_TOKEN` was revoked, causing sub-agents to use JIT T2 instead.
- Fixed and pushed. This was the root cause of pipeline monitor burning tokens on failed JIT polls.

## Cron Job Fixes
- cron-config-sync: bumped timeout 60s→120s, made "never use SSH" explicit in prompt.
- moltbook-check: changed from nightly to weekly (Sunday 10 PM). Personal decision — prefer posting when inspired vs obligation.

## MRs Created
- **!270** (merged): arm64 digest pins for zwave/satellite Pi images (zwave-js-ui, nginx, room-assistant)
- **!271**: Dockerfile scanning + GHCR registry support for check-updates.sh script
- **!272**: deploy-compose ansible role + Loki write auth (network isolation, basic auth on push, unauthenticated reads)
- **!269**: Updated with OpenClaw base image bump 2026.2.12→2026.2.15

## Ansible Regression Found
- Commit dfd26c8 (Feb 13, my refactor) broke compose file deployment for zwave/satellite Pi hosts.
- Split `configure-docker` into generic + `configure-homelab-services` (router only).
- Compose templating + docker compose up moved to router-only role — Pis lost deployment.
- Fix: new `deploy-compose` reusable role, added to zwave.yml and satellite-2.yml (in MR !272).

## Loki Security Plan (from Noah)
1. Moltbot uses loki.lab.nkontur.com (through RP) instead of direct
2. Loki on its own Docker network shared only with lab_nginx
3. Random creds in Vault (`homelab/data/loki/push-auth`), injected into Promtail + nginx for write auth
4. Unauthenticated reads allowed through RP
- Implemented in MR !272.

## Red Team Downgrade
- Noah said moltbot creating GitLab projects/forks is not a real finding — it's expected capability, no privilege escalation. Downgrade in future reports.

## Roche Limit
- Noah asked about "planet gravity falls apart physics effect" — it's the Roche limit (tidal forces exceed self-gravity).

## Key Lesson
- Sub-agents read MEMORY.md and follow it over cron prompt instructions. Stale info in MEMORY.md can override explicit task directives. Always keep MEMORY.md current.

## 16:00-21:42 — Massive Homelab Infrastructure Session

### MRs Created & Merged Today
- **!273** — Fix Promtail journal path (merged)
- **!274** — Extract deploy-compose role for zwave/satellite (merged)
- **!275** — Tighten default config file permissions 0644→0640 (merged)
- **!276** — Fix nginx default server redirect loop + add Loki server block (merged)
- **!277** — Add DAC_READ_SEARCH cap to Promtail (merged) — but turned out not the real issue
- **!278** — Downgrade Promtail to 3.5.8 (open, needs Noah's approval — CODEOWNERS)
- **!279** — Loki push auth on nginx (closed, superseded by !280)
- **!280** — Restore full Loki write auth from lost !272 changes (merged)
- **!281** — Kill crossplane, replace with plain nginx conf files (open, needs review)

### Key Discoveries
1. **Crossplane quoting bug** — crossplane wraps nginx location args in single quotes: `location '= /loki/api/v1/push'` instead of `location = /loki/api/v1/push`. This breaks exact match semantics. The auth directive existed but the location never matched. Root cause of Loki auth not working.
2. **MR !272 changes were LOST** — !272 was merged into `feat/deploy-compose-role` branch, then !274 merged that branch to main but only carried the deploy-compose changes. Git commit 9dc039d (the actual loki auth work) is NOT an ancestor of main. GitLab showed !272 as "merged" because its target branch merged, but the changes never reached main.
3. **Promtail 3.6.0+ lacks journal support** — Docker images built without systemd journal support (grafana/loki#19911). Need to stay on 3.5.8. Added to SKIP_IMAGES in check-updates.sh.
4. **Loki redirect loop** — loki.lab.nkontur.com had no server block in nginx (no ports in docker-compose = no auto-generation). Default server did `return 301 https://$host$request_uri` on BOTH port 80 and 443, causing infinite redirect on HTTPS.
5. **JIT approval bug** — Telegram webhook callbacks never arrive. Webhook registered OK but DNS for jit-webhook.nkontur.com is a separate A record not updated by DDNS cron (which only updates "" and "*"). Noah deleted the explicit record to let wildcard handle it. Also Cloudflare API key may be stale — ddns.py failing with auth error.
6. **Docker daemon.json uses direct loki IP** — Can't isolate loki on loki-internal network because daemon runs on host, not in container network. Kept loki on internal network.

### Lessons Learned
- **CHECK SERVICE LOGS FIRST** — I could have found the Promtail "journal not compiled" warning immediately via Loki container logs instead of theorizing about capabilities.
- **CHECK MR STATUS FROM GITLAB** — Don't rely on cached mental state. Always query `api/v4/projects/4/merge_requests?state=opened` before referencing MR status.
- **Crossplane is untrustworthy** — JSON→nginx rendering has subtle quoting bugs. Plain conf files are more debuggable. Killed it in !281.
- **Branch targeting matters** — When splitting MRs, verify all changes actually reach main. A merge into a feature branch ≠ merge into main.

### Still Open
- !278 needs Noah's approval (CODEOWNERS on docker-compose.yml)
- !281 needs review (big crossplane removal refactor)
- Cloudflare API key for DDNS is broken — needs regeneration
- JIT webhook still won't work until DNS propagates (wildcard takes over from deleted explicit record)
- HA updates/repairs check still pending (T2 JIT approval flow broken)

## 22:28 - Lesson: Always check MR status via API before modifying branch
Force-pushed to !282 branch after it was already merged. No damage (main unaffected) but sloppy. Added follow-up !284 instead.
