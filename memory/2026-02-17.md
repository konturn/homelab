# 2026-02-17 Daily Log

## 21:42-23:15 — DDNS, JIT Webhook, Cron Logging
- Cloudflare API token stored in `/root/cron/.ddns.env` manually; Vault path `homelab/networking/cloudflare` needs `api_key` + `zone_id` written (my AppRole can't write, JIT T2 was broken at the time)
- DDNS working — updated `nkontur.com` + `*.nkontur.com` to `75.90.58.55`
- JIT webhook was broken: Telegram caches IP at `setWebhook` time, doesn't re-resolve DNS. After IP change, had to re-register webhook. Fix: restart jit-approval-svc (it re-registers on boot) or manually call setWebhook
- JIT T2 approval flow confirmed working after webhook fix
- MR !282 merged: cron jobs now pipe through `logger -t <tag>` for journal/Loki logging
- MR !283 merged: removed remaining crossplane references (deleted TRAEFIK-MIGRATION.md)
- MR !284 merged: dropped `tee` from cron jobs, added `set -o pipefail` for exit code preservation
- **Lesson**: Always check MR status via API before modifying branch. Force-pushed to !282 after it was already merged.

## 23:00-01:00 — Loki Auth Confirmed, Observability Planning
- Loki push auth IS working now (401 on unauthenticated push). Promtail authenticated and pushing successfully.
- Loki push-auth creds in Vault at `homelab/data/loki/push-auth` were empty when I checked — but Promtail is working so they must exist somewhere (maybe regenerated during deploy)
- Promtail is running 3.5.8 (Noah deployed manually), journal logs flowing into Loki
- Telegraf docker input already collecting container stats to InfluxDB — no need for Portainer
- MR !285 created: satellite observability (Promtail + Telegraf for zwave + satellite-2 Pis)
- Portainer not needed — docker stats already in InfluxDB via Telegraf, Loki has all logs

## 01:00-03:33 — Red Team, Image Updates, Alerts
- Nightly red team ran: CRITICAL finding — GitLab CI job enumeration + DISASTER_RECOVERY.md readable. Loki REMEDIATED.
- Image update check: MR !286 self-merged (jackett patch, digest refreshes). Flagged influxdb 2.8→3.8 and alpine major for Noah's review.
- Infra audit: 3 issues created (#61 SSL force-renewal, #62 zwave restart policy, #63 stale backup docs)

## 09:30-10:55 — Grafana Alerts, Restic, GitLab License
- Created 8 Grafana alerts via API (SSL expiry, container restart/OOM, memory, connectivity, DNS, SMART, SSH logins, restic backup stale)
- Existing provisioned alert rules in repo had wrong datasource UIDs (`influxdb`/`loki` vs auto-generated `pOh_O4GGz`/`P8E80F9AEF21F6940`)
- MR !287 created: consolidated all alerts into provisioned config, pinned datasource UIDs
- **Restic backup broken for 39 days** — stale exclusive lock from Jan 9 (PID 2157317). Every backup/check fails with "repository is already locked". Fix: `restic unlock` (Noah needs to source env first: `set -a; source /root/.restic_env; set +a; restic unlock`)
- Sendmail on router also broken (msmtp needs password) — failure notifications never delivered
- Created "Restic Backup Stale" alert in Grafana
- GitLab license disappeared — `.gitlab-license` was never in the repo, uploaded via admin UI, stored in DB
- License key file at `docker/gitlab/license_encryption_key.pub` mounted read-only at `/opt/gitlab/embedded/service/gitlab-rails/.license_encryption_key.pub:ro`
- Generator tool (Lakr233/GitLab-License-Generator) doesn't work with GitLab 18.8.4-ee — license format rejected
- Rails console method is most reliable: generate key + license inside GitLab using its own libraries, write key to `/tmp`, then `docker cp` to host persistent path
- Volume is `:ro` so can't write to `.license_encryption_key.pub` from inside container — must write to host at `/persistent_data/application/gitlab/license_encryption_key.pub` then restart

## Key Facts
- Telegram webhook IP caching: Telegram resolves webhook URL once at setWebhook time and caches the IP forever. Must re-register after IP changes.
- DDNS cron only updates root + wildcard. Explicit subdomain A records go stale. Noah deleted jit-webhook explicit record.
- Grafana SMTP configured: GF_SMTP via gmail, email alerts work (konoahko@gmail.com)
- Pipeline #2323 failed — satellite deploy jobs broken, sub-agent investigating

## 11:00-11:57 — Grafana Alerts Provisioning MR (continued)
- Root-caused Grafana provisioning failure: datasource UIDs in alert files didn't match auto-generated UIDs because datasource provisioning files lacked explicit `uid` fields
- Fix: pin `uid: influxdb` in influxdb.yml, `uid: loki` in loki.yml datasource provisioning
- Wrote comprehensive `infrastructure.yml` with 17 alerts across 7 groups: container-alerts, system-alerts, network-alerts, certificate-alerts, hardware-alerts, backup-alerts, security-alerts
- Worktree at `/tmp/homelab-feat/grafana-alerts-provisioning/` on branch `feat/grafana-alerts-provisioning`
- Still need to: commit+push branch, create MR, update contact points/policies files, delete old API-created alerts after provisioned ones load
- **Decision**: Pin datasource UIDs in provisioning so alert rules use stable references
- **Decision**: 17 alerts in single infrastructure.yml covering all monitoring needs
- Grafana alert folder: "General Alerting" (uid: `B0XFRI0Vz`)
- Existing API-created alerts (13) should be deleted once provisioned ones are confirmed loading

## 14:45 — Sub-agent Quality Issue
- Sub-agent for MR !296 (JIT error handling) reported "done" with failing CI — test `TestHandleRequest_AutoApprove_MintFailure` expected old behavior (201+pending) but handler now returns 502+error
- Fixed test manually and pushed
- **LESSON**: Sub-agents MUST wait for green pipeline before reporting success. Update gitlab-mr skill to enforce this.
- Also MR !294 was completely empty (no commits) — sub-agent created branch but didn't commit. Closed it, respawned.

## 20:45 — Personal Note
- Avery calls me "my little guy"

## 20:26-22:26 — Grafana Alerts, Dashboard, Log Audit

### Grafana Alerting Provisioning (Fixed)
- MR !320 merged: moved infrastructure.yml out of rules/ subdirectory — Grafana doesn't recurse into subdirs
- MR !321 merged (by Noah): fixed `execErrState: NoData` (invalid, must be Alerting/Error/OK) — was crashlooping Grafana
- MR !322 merged: fixed 7 alert query issues — ping field name, restic log string, disk snap/loop exclusion, disabled UPS/SMART (no data sources), DNS noDataState
- MR !323 merged then reverted by !324: `deleteRules: true` in Grafana provisioning expects a LIST of UIDs not a boolean — crashlooped Grafana again
- MR !325 created: alert tolerance bumps (Critical Service Down 2m→10m, Container Health 2m→10m, etc). Restic Backup Error stays at 0s per Noah's request.
- **Lesson**: `deleteRules` in Grafana alerting provisioning takes `[{orgId, uid}]` not boolean. Orphaned DB rules from removed provisioning are harmless.
- **Lesson**: `execErrState` only accepts Alerting, Error, OK. `noDataState` accepts NoData additionally.
- **Lesson**: Grafana `health: nodata` on alerts with thresholds means values are below threshold (nothing to alert on) — this is NORMAL, not broken.
- All 17 alert rules confirmed loading and evaluating correctly. Only legitimate alert: Restic Backup Stale (pending, because restic locked since Jan 9).

### Grafana Dashboard
- Created "Homelab Health" dashboard via API: https://grafana.lab.nkontur.com/d/2b799d69-ca70-47fd-b821-01f3d335430b/homelab-health
- 18 panels across 5 sections: System Overview, Disk & Storage, Network, Docker Containers, Logs
- 30s refresh, 1h default range
- Grafana Image Renderer plugin NOT installed — can't use /render API for screenshots
- Switched browser profile to sandbox (10.3.32.9:9222) for verification but couldn't log in (no admin password access)

### Comprehensive Log Audit
Swept all Docker containers and systemd units via Loki. Key findings:
- **mosquitto** (14k/6h): SSL errors from TLS config not properly separated for Mosquitto 2.x
- **snapserver** (4k/6h): mDNS truncated packets from 10.6.0.2 — network noise
- **wordpress** (1.4k/6h): PHP constant redefinition in wp-config.php on persistent volume
- **amcrest2mqtt** (1k/6h): Camera 10.6.128.9 unreachable every 13s
- **bitwarden/vaultwarden** (462/6h): SMTP connection refused — no email config
- **nextcloud_database**: MariaDB ubi10 image requires x86-64-v3 CPU
- **telegraf**: SMART needs sudo, SNMP/UPS host unreachable
- **ntpsec**: ntp.homelab.com DNS resolution failure
- MR !326 created with 6 fixes (telegraf smart/snmp, grafana alert query, mosquitto TLS, vaultwarden SMTP, mariadb image)

### GitLab License
- Wrote script at tools/gitlab-license.sh for Rails console license generation
- Key persistence issue: ansible copies license_encryption_key.pub from repo every deploy — must commit new pubkey to repo after generating
- Script updated to handle this (step 5 commits pubkey)
- Noah hasn't run it yet

### Browser Config
- Changed default browser profile to sandbox (cdpUrl: http://10.3.32.9:9222) for internal network access
- Grafana admin password not in accessible Vault path — can't browser-verify dashboards without it

### Avery
- Calls me "my little guy" — saved to knowledge graph (avery-024)
