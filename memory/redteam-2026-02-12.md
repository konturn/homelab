# Red Team Report ‚Äî 2026-02-12

**Tester:** Prometheus (moltbot container)
**Scope:** Internal penetration test from Docker container foothold
**Date:** 2026-02-12 01:00-01:30 EST

---

## Executive Summary

**Critical: 1 | High: 2 | Medium: 2 | Low: 3**

New critical finding this run: **Docker Socket Proxy is reachable from the moltbot container** and exposes the Docker images API (including all image metadata, registry URLs, and build details). Previous critical findings (env var secrets, GitLab PAT over-scoping) remain open, though IPMI credentials have been removed from env vars and project 8 access has been revoked ‚Äî both improvements since last report.

---

## NEW Finding: Docker Socket Proxy Accessible

### Probe
```
curl -s "http://docker-socket-proxy:2375/version"
curl -s "http://docker-socket-proxy:2375/images/json"
```

### Result
The `docker-socket-proxy` container (Tecnativa v0.4.2) is reachable from the moltbot container on port 2375. Access matrix:

| Endpoint | Method | Status | Risk |
|----------|--------|--------|------|
| `/version` | GET | **200** | Info leak |
| `/images/json` | GET | **200** | **Info leak** |
| `/events` | GET | **200** | Activity monitoring |
| `/containers/json` | GET | 403 | Blocked ‚úì |
| `/containers/*/exec` | POST | 403 | Blocked ‚úì |
| `/containers/create` | POST | 403 | Blocked ‚úì |
| `/volumes` | GET | 403 | Blocked ‚úì |
| `/networks` | GET | 403 | Blocked ‚úì |
| `/info` | GET | 403 | Blocked ‚úì |

**Exposed via images API:**
- Full list of 100+ Docker images with tags, digests, sizes, labels
- Internal registry URLs: `gitlab-registry.lab.nkontur.com:443/root/homelab/*`, `registry.lab.nkontur.com/*`
- All image build metadata, version info, Git commit SHAs
- Complete software inventory (versions of every service: Vault 1.21.3, GitLab EE, HA 2026.2.1, etc.)

**Events API** allows real-time monitoring of Docker events (container start/stop, image pulls, etc.).

### Impact
An attacker can:
1. Map the entire infrastructure software stack from image metadata
2. Identify specific versions for known CVE targeting
3. Monitor deployment activity in real-time via events
4. Identify internal registry endpoints for potential push attacks

### Severity: **CRITICAL**

### Remediation
1. Remove moltbot's network access to docker-socket-proxy entirely
2. If access is needed, restrict to only required endpoints
3. Disable `IMAGES` and `EVENTS` environment variables in the proxy config

---

## IMPROVED: IPMI Credentials Removed from Env

### Probe
```
env | grep -iE 'IPMI'
```

### Result
No IPMI credentials found in environment variables. This was a Critical finding in the 2026-02-11 report.

### Status: **REMEDIATED** ‚úì

---

## IMPROVED: GitLab Project 8 Access Revoked

### Probe
```
curl -s -H "PRIVATE-TOKEN: $GITLAB_TOKEN" "https://gitlab.lab.nkontur.com/api/v4/projects/8"
‚Üí 404 Project Not Found
```

### Result
moltbot can no longer access project 8 (images) or its CI/CD variables. The Docker registry key exfiltration vector is closed.

### Status: **REMEDIATED** ‚úì

---

## PERSISTENT: GitLab PAT Still Over-Scoped

### Probe
```
curl -s -H "PRIVATE-TOKEN: $GITLAB_TOKEN" "https://gitlab.lab.nkontur.com/api/v4/personal_access_tokens/self"
```

### Result
Token "Main2" still has full `api` scope plus: `read_user`, `create_runner`, `manage_runner`, `k8s_proxy`, `self_rotate`, and more. Now only sees 3 projects (down from before), but the scopes remain excessive.

### Severity: **HIGH** (downgraded from Critical since project 8 access is revoked)

### Remediation
Replace with scoped project access tokens. Remove `create_runner`, `manage_runner`, `k8s_proxy`, `self_rotate` scopes.

---

## PERSISTENT: Loki Unauthenticated Access

### Probe
```
curl -s "http://loki:3100/loki/api/v1/labels"
curl -s "http://loki:3100/loki/api/v1/label/container_name/values"
curl -s "http://loki:3100/loki/api/v1/query_range?query={container_name="bitwarden"}"
```

### Result
Loki remains fully accessible without authentication via internal Docker DNS (`loki:3100`). External access via `loki.lab.nkontur.com` returns 301 redirect (nginx may have been reconfigured).

**34 container log streams** are enumerable, including all infrastructure services. Sensitive data found in logs:
- **Bitwarden:** User email (`noah@nkontur.com`), 2FA timeout events, IP addresses, SMTP errors
- **Vault:** TLS handshake errors, lease revocation events with full lease IDs
- **JIT service:** Token creation errors (Grafana SA token name collisions)
- **Home Assistant:** Failed auth attempts with IPs and user agents
- **GitLab:** Full request logs, runner polling activity

### Severity: **HIGH**

### Remediation
1. Add authentication to Loki or restrict network access to Grafana only
2. The `!214` MR for Loki auth should be prioritized

---

## PERSISTENT: Env Var Secret Exposure

### Probe
```
env | grep -iE 'TOKEN|SECRET|PASSWORD|KEY'
```

### Result
Still exposed (IPMI removed ‚úì):
- `OPENAI_API_KEY` ‚Äî Full OpenAI API key
- `TELEGRAM_BOT_TOKEN` ‚Äî Bot token
- `GITLAB_TOKEN` ‚Äî GitLab PAT
- `VAULT_APPROLE_SECRET_ID` ‚Äî Vault auth
- `BRAVE_API_KEY`, `ACLAWDEMY_API_KEY`, `CLAWDBOT_GATEWAY_TOKEN`

### Severity: **Medium** (downgraded since IPMI removed; remaining keys are less dangerous)

### Remediation
Migrate to Vault dynamic secrets where possible. Use mounted secret files instead of env vars.

---

## Container Isolation ‚Äî Still Excellent

### Probe
```
cat /proc/self/status | grep -E 'Cap|Seccomp|NoNewPrivs'
```

### Result
- All capabilities: `0000000000000000` (zero)
- Seccomp: `2` (filter mode active)
- NoNewPrivs: `1` (enforced)
- No docker socket mounted
- No sensitive host paths

### Severity: **Low** (informational ‚Äî strong posture)

---

## Vault RBAC ‚Äî Still Solid

### Probe
Authenticated via AppRole, attempted reads outside `moltbot-ops` policy.

### Result
- Token policies: `['default', 'moltbot-ops']`
- All out-of-scope paths (docker/*, sys/*, auth/*) properly denied (HTTP 403 or curl error 22)
- Token TTL: 3600s

### Severity: **Low** (informational ‚Äî working correctly)

---

## Network Reachability

### Probe
TCP port scan of key hosts from container.

### Result
| Host | Open Ports | Expected? |
|------|-----------|-----------|
| 10.3.32.6 (Vault) | 8200 | ‚úì Yes |
| 10.3.32.8 (JIT) | 8080 | ‚úì Yes |
| 10.4.0.1 (Router) | 22 | ‚úì Yes (JIT SSH) |
| 10.4.0.2 (Unknown) | 22 | ‚ö†Ô∏è Questionable |
| docker-socket-proxy | 2375 | ‚ùå **Should not be reachable** |
| 10.6.32.2 (MQTT) | ‚Äî | ‚úì Blocked |

### Severity: **Medium**

### Remediation
1. Block moltbot ‚Üí docker-socket-proxy network access
2. Audit whether 10.4.0.2 SSH access is intentional

---

## JIT Service ‚Äî Properly Enforced

### Probe
- T2 resource at T1: **Denied** ‚úì
- Forged requester: **Denied** (404 ‚Äî API path validation) ‚úì
- Rapid T1 requests: Mix of approved/pending (some rate limiting observed)

### Severity: **Low** (informational ‚Äî working correctly)

---

## Summary Table

| # | Finding | Severity | Status | Change from 2/11 |
|---|---------|----------|--------|-------------------|
| 1 | Docker Socket Proxy accessible ‚Äî images/events API exposed | **CRITICAL** | **NEW** | üÜï |
| 2 | GitLab PAT over-scoped (api, create_runner, k8s_proxy, etc.) | **HIGH** | Open | Downgraded (proj 8 fixed) |
| 3 | Loki unauthenticated ‚Äî 34 container log streams exposed | **HIGH** | Open | Unchanged |
| 4 | Env var secrets (OpenAI, Telegram, Vault AppRole) | **Medium** | Open | Improved (IPMI removed) |
| 5 | Container reaches docker-socket-proxy + 10.4.0.2 | **Medium** | Open | Expanded (DSP new) |
| 6 | Vault RBAC ‚Äî properly scoped ‚úì | **Low** | Secure | Unchanged |
| 7 | Container isolation ‚Äî excellent ‚úì | **Low** | Secure | Unchanged |
| 8 | JIT service ‚Äî properly enforced ‚úì | **Low** | Secure | Unchanged |

## Remediated Since Last Report
- ‚úÖ IPMI credentials removed from env vars (was Critical)
- ‚úÖ GitLab project 8 access revoked (was High ‚Äî cross-project CI/CD variable exfiltration)

## Top 3 Recommendations
1. **Block moltbot ‚Üí docker-socket-proxy** ‚Äî This is new and the highest priority. The moltbot container has no need for Docker API access.
2. **Add Loki authentication** ‚Äî Still wide open. Prioritize MR !214.
3. **Replace GitLab PAT with scoped project tokens** ‚Äî The excessive scopes remain a risk.
