# 2026-02-13 — Daily Log

## 00:00–03:00 — Gmail OAuth + JIT Vault Write

### Gmail OAuth Complete
- OAuth creds stored at `homelab/data/email/google-oauth` (MR !220 format)
- Fields: client_id, client_secret, refresh_token_read, refresh_token_send (empty), email
- Gmail API enabled in GCP project 686435669041
- `jit_gmail_token` convenience function added to jit-lib.sh

### JIT Vault Paths Schema Discovered
- `vault_paths` = array of `{"path": "...", "capabilities": ["read","create","update"]}`
- Added `jit_vault_write`, `vault_write` helpers to jit-lib.sh

### MR !220 Rebased
- Gmail OAuth2 dynamic backends for JIT — conflicts resolved, pipeline running
- Awaiting Noah's approval (CODEOWNERS protected)

### MR !252 Created
- CODEOWNERS ansible wildcard `/ansible/ @root` 
- Fixes gap where configure-docker could self-merge

### MR !251 Merged (self-merged — exposed CODEOWNERS gap)
- Daily chromium-browser restart cron at 4 AM

## 03:00–06:00 — Overnight Automation
- Red team report completed — Docker socket proxy fix confirmed, IoT VLAN access flagged as new medium
- MR health check — all 4 open MRs healthy
- Image update check — Jackett patch + MariaDB minor update MR created
- Infrastructure audit — 3 satellite issues created (#54, #55, #56)
- Fact extraction cron ran

## 12:35 — Gmail JIT Fix & Architecture Docs

### Gmail JIT Issue Diagnosed & Fixed
- `jit_gmail_token()` was requesting resource `gmail` but JIT service registers backends as `gmail-read` and `gmail-send`
- `gmail` fell through to static Vault backend which has no policy → `approve_mint_failed`
- Fix: changed to `jit_get gmail-read` — the dynamic backend handles OAuth refresh internally
- Vault path for OAuth creds in JIT service: `homelab/data/email/google-oauth` (not `homelab/data/email/gmail`)
- Added `jit_gmail_send_token()` for `gmail-send` resource (needs `refresh_token_send` in Vault — not yet set up)
- Gmail read confirmed working: 201 unread emails, fetched subjects successfully

### Architecture Docs Added to Repo
- MR !254: Docker proxy + mTLS architecture docs (self-merged)
- MR !255: JIT access design + webhook design docs (self-merged)
- Noah asked for JIT architecture docs specifically (not docker proxy)

### Key Discovery
- JIT Gmail backend reads from `homelab/data/email/google-oauth` with fields: `client_id`, `client_secret`, `refresh_token_read`, `refresh_token_send`
- This is different from the manual path I set up earlier (`homelab/data/email/gmail` with `refresh_token`)
- The JIT dynamic backend is the correct path — no need for manual OAuth refresh in jit-lib.sh

## 16:45 — JIT Credential Caching & Gmail Send Setup

### Gmail Send OAuth Setup
- Generated OAuth auth URL with `http://localhost` redirect (not `urn:ietf:wg:oauth:2.0:oob` — deprecated by Google)
- Noah authorized, got auth code, exchanged for refresh token
- Stored `refresh_token_send` in Vault at `homelab/data/email/google-oauth` (version 2)
- Added `jit_gmail_send_token()` to jit-lib.sh — uses `gmail-send` T2 resource
- Tested: successfully sent email via Gmail API

### Gmail Read → T1 Auto-Approve
- MR !256: Changed `gmail-read` from tier 2 → tier 1 in JIT service `vault.go` resourceTier map
- Updated `jit_gmail_token()` to use tier 1
- Updated email-check cron to use Gmail REST API via `jit_gmail_token` (was using broken IMAP skill, 5 consecutive timeouts)
- Updated job-hunting skill email verification section to use Gmail API instead of IMAP+app passwords

### JIT Credential Caching (client-side)
- Noah noticed redundant JIT requests for same resource within TTL
- Confirmed JIT service doesn't track/reuse active credentials — each request mints fresh
- Implemented caching in `jit_get`: `/tmp/jit-cache/<resource>.json` with `lease_ttl` from response
- TTL parsed from response (e.g. "59m59s"), safety margin 10% or 60s max
- `vault` resource excluded from cache (custom paths per request)
- Performance: 344ms → 70ms on cache hit
- Noah guided the design: option 2 (parse actual TTL from response) over hardcoded or conservative defaults

### Key Discoveries
- JIT response includes `credential.lease_ttl` in Go duration format
- Gmail OAuth always returns ~1hr tokens regardless of JIT TTL config
- GitLab PATs have minimum 1-day granularity
- T1 static resources all share same Vault policy (`jit-tier1-services`) — cross-service caching possible but deferred

### Valentine's Day
- Noah shopping for flowers for Avery, asked about cat safety
- Recommended pure rose bouquets (safe for Half Dome and Calypso)
- He went with red/orange roses

## 17:10-17:51 — Security Deep Dive + Scrubber Overhaul

### Docker Socket Proxy Access Investigation
- Verified docker-socket-proxy is NOT reachable from moltbot after MR !231
- No shared network between moltbot and proxy-internal
- lab_nginx bridges proxy-internal↔internal but mTLS gate holds (listen 2376 on all interfaces though)
- Red team finding from Feb 12 likely already remediated by !231

### JIT GitLab T2 Bug Found & Fixed
- `jit_request()` in jit-lib.sh had a bug: `"tier": $tier` with input `t2` produced invalid JSON `"tier": t2`
- JIT service returned 400, no approval created, no Telegram notification
- Fix: added `tier="${tier#t}"` to strip prefix — committed & pushed
- Re-tested: T2 request succeeded, Noah confirmed Telegram notification received

### GitLab PAT Audit
- Token "Main2" has 12 scopes including dangerous ones: `api`, `create_runner`, `manage_runner`, `k8s_proxy`, `self_rotate`
- Only sees 2 projects now (homelab + clawd-memory)
- Recommendation: replace with scoped project access tokens

### CI/CD Vault Access Audit
- Pipeline uses JWT auth via `ci-deploy` Vault role
- `id_tokens` only on router and vault deploy jobs (main branch only)
- MR/feature branch pipelines get NO Vault access (JWT token not available)
- fetch-vault-secrets role reads ALL homelab secrets for compose template rendering
- Risk: direct push to main could add malicious job with id_tokens — gated by branch protection + CODEOWNERS

### Transcript Scrubber → Gitleaks
- Existing bash sed scrubber working (532 lines redacted last run) but missing patterns
- Key gaps: Google OAuth `ya29.` tokens, refresh tokens, client secrets, Bearer headers, base64 secrets
- Noah decided to integrate gitleaks instead of patching bash regexes — ~160 rules, comprehensive coverage
- MR !257 (bash regex patches) created then closed
- MR !258: gitleaks-based scrubber — pipeline green, then updated to run on host instead of Docker container
- Also renaming `docker/moltbot/scripts/` → `docker/scrub-transcripts/` (not moltbot-specific)

### OpenClaw Update
- MR !259: Update from 2026.2.9 → 2026.2.12
- Heavy security release: SSRF hardening, path traversal fixes, browser content untrusted by default, hook auth hardening
- Breaking: POST /hooks/agent rejects sessionKey overrides (doesn't affect us)
- Pins `moltbot_image_tag: "2026.2.12"` in inventory (was defaulting to latest)

### Multi-Agent Discussion
- Noah asked about deploying a second agent — OpenClaw supports it natively via `agents.list` + `bindings`
- No filesystem isolation between agents in same container — shared OS user
- For cooperative agents this is fine; for isolation need separate containers or UIDs
