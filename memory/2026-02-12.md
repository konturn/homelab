
## 09:22 — Docker Socket Proxy Isolation

### MR !231: Remove moltbot from mgmt network
- Red team critical finding: moltbot could reach docker-socket-proxy on mgmt network
- Only docker-socket-proxy and moltbot-gateway were on mgmt network
- moltbot doesn't need docker socket access — removed from mgmt network
- Also removed unused moltbot_gateway_ip from inventory
- Sub-agent pushed branch but failed to create MR — had to create manually

### Cron fixes overnight
- Fixed MR Health Check and email-check crons — were using `source` (bash) in sh shell
- Added `bash -c 'source ...'` note to both cron prompts

### Open MR summary (growing!)
!199, !202, !203, !207, !210, !214, !215, !216, !218, !220, !221, !222, !224, !225, !226, !228, !229, !231
Key merges needed: !231 (critical security), !228 (cap sweep), !222+!224 (scrub fixes), !225 (rsyslog replacement)

### Sub-agent reliability note
- Sub-agent for mgmt network fix pushed code but didn't create MR (reported "no output")
- Need to verify sub-agent output, not just trust completion status

## 10:00 — Docker Proxy Network Testing + Browser Research

### MR !231 merged — docker-proxy network broken
- Pipeline green, merged, but docker builds fail
- gitlab-runner still using old `DOCKER_HOST=tcp://10.4.32.2:2375` despite config being updated
- Hot-reload doesn't work for `environment` and `network_mode` in `[runners.docker]` section
- Needs `sudo systemctl restart gitlab-runner` on router
- Should add Ansible handler to auto-restart gitlab-runner on config changes

### Headless browser research (Reddit post)
- Noah asked about headless-shell for job apps
- headless-shell non-starter: HeadlessChrome UA flagged, missing APIs for bot detection
- Full Chromium sidecar (Xvfb/noVNC) better but overkill
- Recommended: stick with OpenClaw browser relay for applications (real Chrome = undetectable)
- Headless sidecar only useful for background scraping where detection doesn't matter
- Key insight from post: CAPTCHAs are identity problems, not technical ones
- Post author's 1Password JIT pattern similar to our Vault JIT

### Ansible handler needed
- gitlab-runner config.toml has no restart handler
- Changes to network_mode/environment require service restart
- TODO: Add handler to configure-base role

## 11:05 — Chromium Browser Sidecar

### MR !232: Headed Chromium sidecar
- Full Chromium + Xvfb + x11vnc + noVNC in Docker container
- Anti-detection: `--disable-blink-features=AutomationControlled`, persistent profile, real window size
- CDP on port 9222 for moltbot to control, noVNC on 6080 for Noah to watch
- VNC password auth from Vault (`homelab/data/docker/chromium-browser` → `vnc_password`)
- nginx proxy at `browser.lab.nkontur.com` with WebSocket support
- Vault secret created with random password ✅
- CI build job added (manual, images runner)
- On internal Docker network so moltbot can reach CDP

### Vault access notes
- AppRole token has READ only on homelab/data/* — cannot write
- Vault WRITE requires JIT T2 request with `vault_paths` containing `{path, capabilities}` objects
- Example: `{"vault_paths":[{"path":"homelab/data/docker/chromium-browser","capabilities":["create","update"]}]}`
- T2 requires Noah's approval via Telegram

### JIT vault_paths API format
```json
{"resource":"vault","tier":2,"reason":"...","vault_paths":[{"path":"homelab/data/...","capabilities":["read","create","update"]}]}
```

## 11:20 — JIT Telegram Detail + Docker Runner Networking

### MR !234: JIT Telegram notification detail
- Approved/denied/timeout messages now retain full request context
- Sub-agent created branch with changes but MR showed empty diff (same bug as !223)
- Had to close !233 and recreate as !234 — diff showed up on recreate
- Recurring sub-agent bug: branches pushed correctly but MRs sometimes created with empty diff

### Docker runner networking issue
- `network_mode` in gitlab-runner config.toml only supports ONE network
- No native multi-network support in Docker executor
- CI images runner needs: docker-socket-proxy access + internet + internal DNS
- Solution: make docker-proxy bridge non-internal (allows NAT internet) + add `dns = ["10.4.0.1"]` to runner config
- Runner still needs `sudo systemctl restart gitlab-runner` to pick up config changes (no hot-reload for network_mode/environment)
- TODO: Add Ansible handler to restart gitlab-runner on config changes

## 11:50 — Docker Proxy Network Deep Dive

### The multi-network problem
- gitlab-runner `network_mode` only supports ONE network
- CI images runner needs: docker-socket-proxy + internet + gitlab registry
- Registry at `gitlab-registry.lab.nkontur.com` resolves to 10.3.32.1 (internal network)
- Host networking not acceptable — gives CI jobs effective root on host
- Docker has no native multi-network support for runner containers

### Solution: host-gateway + extra_hosts
- GitLab already publishes 443:80 on the host
- Docker's `host-gateway` special hostname routes to Docker host IP
- `extra_hosts = ["gitlab-registry.lab.nkontur.com:host-gateway"]` in runner config
- CI job hits registry via host's published port, no internal network needed
- docker-proxy stays non-internal bridge (internet via NAT)
- No DNS server needed

### Key facts
- Router (10.4.0.1) is NOT a DNS server — I incorrectly assumed it was
- `network_mode = "host"` for images runner = security risk (root on host)
- docker-socket-proxy with IMAGES=1, BUILD=1, AUTH=1 exposes software inventory + registry auth — network isolation is important
- GitLab gitlab-ee publishes ports: 22/tcp, 443:80

### MRs
- !231: already merged (old version without DNS fix)
- !235: needs updating with host-gateway approach

## 16:45 — Docker Proxy TLS + Runner Config Session

### MRs Created/Updated
- **MR !236**: Docker socket proxy TLS + mTLS — went through 3 iterations:
  1. Dedicated nginx sidecar (original)
  2. Moved to lab_nginx (Noah's suggestion)
  3. Removed lab_nginx from mgmt, runners on proxy-internal
  → Merged
- **MR !237**: Single runner on host network, `DOCKER_HOST=tcp://lab.nkontur.com:2376` — merged
- **MR !238**: Cert ordering fix (certs before compose up) — merged but incomplete
- **MR !239**: Better cert cleanup (check all 5 files, purge if any are dirs) — pipeline green

### Key Decisions
- **Single runner**: Consolidated from 2 runners (main + images) to 1 on host network
- **lab_nginx stays off mgmt**: Noah explicitly said no. Runners reach it via `lab.nkontur.com` (wildcard DNS)
- **Docker creates directory artifacts**: When bind mount source doesn't exist, Docker creates dirs. Root cause of cert mount failures.
- **after_script failure**: Deploy succeeded but runner after_script fails mounting certs — needs runner restart to clear stale mount cache

### Cert Generation Chicken-and-Egg
- Runner config mounts certs into job containers
- If certs don't exist, ALL jobs fail (including the deploy that would create them)
- Manual cert gen on router is the bootstrap path
- Noah was frustrated with multiple rounds of fixes — "why is this so fucking hard?"

### JIT Webhook Design
- Noah wants JIT approval bot to PUSH notifications to OpenClaw instead of agents polling
- Design doc written at `docs/jit-webhook-design.md`
- Uses `/hooks/agent` endpoint for direct session targeting
- Security: Bearer token + Ed25519 signatures + request ID correlation

### Skill Update
- Added merge conflict check requirement to `skills/gitlab-mr/SKILL.md` — sub-agents must verify `has_conflicts: false` via API before reporting done

### Noah Feedback
- Called me "sluggish" (meaning stupid, not slow) — need to be sharper
- Frustrated with sub-agents needing multiple rounds (!238 already merged, !237 already merged, cert ordering incomplete)
- "do research into openclaw to figure it out for yourself!" — be more self-sufficient
