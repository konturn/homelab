server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions/positions.yaml

clients:
  - url: https://loki.lab.nkontur.com/loki/api/v1/push
    basic_auth:
      username: promtail
      password: "{{ vault_loki_push_password }}"
    tls_config:
      insecure_skip_verify: true

scrape_configs:
  # Systemd journal - scrapes all host logs directly from journal
  # Replaces rsyslog-dependent file jobs (syslog, auth, kernel, cron)
  - job_name: journal
    journal:
      json: false
      max_age: 48h
      labels:
        job: systemd-journal
        host: router
      # path auto-detected: checks /var/log/journal then /run/log/journal
    relabel_configs:
      - source_labels: ['__journal__systemd_unit']
        target_label: 'unit'
      - source_labels: ['__journal_syslog_identifier']
        target_label: 'syslog_identifier'
      - source_labels: ['__journal_priority_keyword']
        target_label: 'level'

  # Docker container logs (json-file driver)
  # Discovers containers via Docker socket, reads JSON log files
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 30s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'
      - source_labels: ['__meta_docker_container_id']
        target_label: 'container_id'
      - action: replace
        target_label: 'source'
        replacement: 'docker'
      - action: replace
        target_label: 'host'
        replacement: 'router'
      - action: replace
        target_label: 'job'
        replacement: 'docker'
    pipeline_stages:
      - docker: {}

  # Credential scrubber audit log
  - job_name: scrub-transcripts
    static_configs:
      - targets: [localhost]
        labels:
          job: scrub-transcripts
          host: router
          __path__: /var/log/scrub-transcripts/*.log

  # Vault audit logs (JSON format)
  - job_name: vault-audit
    static_configs:
      - targets: [localhost]
        labels:
          job: vault-audit
          host: router
          __path__: /vault/logs/audit.log
    pipeline_stages:
      - json:
          expressions:
            type: type
            auth_accessor: auth.accessor
            operation: request.operation
            path: request.path
      - labels:
          type:
          operation:
