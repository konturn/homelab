# Telegraf Configuration for Homelab
# Comprehensive monitoring for infrastructure visibility

[global_tags]
  host = "router"

[agent]
  interval = "30s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "5s"
  flush_interval = "30s"
  flush_jitter = "5s"
  precision = "0s"
  hostname = ""
  omit_hostname = false

###############################################################################
#                            OUTPUT PLUGINS                                    #
###############################################################################

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "${INFLUXDB_ADMIN_TOKEN}"
  organization = "homelab"
  bucket = "metrics"

###############################################################################
#                            INPUT PLUGINS                                     #
###############################################################################

# ============================================================================
# System Health - Core metrics
# ============================================================================

[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = false

[[inputs.mem]]

[[inputs.swap]]

[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]

[[inputs.diskio]]
  devices = ["sd*", "nvme*"]

[[inputs.system]]

[[inputs.processes]]

[[inputs.kernel]]

# ============================================================================
# SMART Disk Health - Predict failures before they happen
# ============================================================================

[[inputs.smart]]
  path_smartctl = "/usr/sbin/smartctl"
  path_nvme = "/usr/sbin/nvme"
  use_sudo = true
  attributes = true

# ============================================================================
# Hardware Sensors - Temps, fans, voltages
# ============================================================================

[[inputs.sensors]]
  # Requires lm-sensors installed on host

# ============================================================================
# IPMI - Server hardware monitoring
# ============================================================================

[[inputs.ipmi_sensor]]
  interval = "60s"
  servers = ["${IPMI_USER}:${IPMI_PASS}@lan(10.4.128.7)"]
  metric_version = 2
  timeout = "20s"

# ============================================================================
# Network - Connectivity and traffic
# ============================================================================

[[inputs.net]]
  interfaces = ["eth*", "enp*", "ens*", "br*", "docker*"]
  ignore_protocol_stats = false

[[inputs.netstat]]

[[inputs.ping]]
  urls = ["1.1.1.1", "8.8.8.8", "google.com"]
  count = 3
  ping_interval = 1.0
  timeout = 2.0
  interval = "60s"

[[inputs.dns_query]]
  servers = ["10.3.32.2"]  # pihole
  domains = ["google.com", "cloudflare.com"]
  record_type = "A"
  timeout = "5s"
  interval = "60s"

# ============================================================================
# Docker - Container stats and health
# ============================================================================

[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  gather_services = false
  source_tag = false
  container_name_include = []
  container_name_exclude = []
  timeout = "5s"
  perdevice = true
  perdevice_include = ["cpu", "blkio", "network"]
  total = true
  total_include = ["cpu", "blkio", "network"]
  docker_label_include = []
  docker_label_exclude = []

# ============================================================================
# Service Health - HTTP endpoint checks
# ============================================================================

[[inputs.http_response]]
  urls = [
    "http://plex:32400/web/index.html",
    "http://homeassistant:8123",
    "http://grafana:3000/api/health",
    "http://radarr:7878/api/v3/health",
    "http://sonarr:8989/api/v3/health",
    "http://pihole:80/admin",
    "http://influxdb:8086/health",
    "http://ombi:3579/api/v1/Status"
  ]
  response_timeout = "10s"
  method = "GET"
  follow_redirects = true
  interval = "60s"

# ============================================================================
# Certificate Expiry - Never get surprised by cert issues
# ============================================================================

[[inputs.x509_cert]]
  sources = [
    "https://grafana.lab.nkontur.com:443",
    "https://gitlab.lab.nkontur.com:443",
    "https://nextcloud.nkontur.com:443"
  ]
  interval = "6h"
  timeout = "30s"

# ============================================================================
# UPS - Power monitoring (uncomment if using NUT)
# ============================================================================

# [[inputs.upsd]]
#   server = "localhost"
#   port = 3493

# ============================================================================
# Systemd - Service status
# ============================================================================

[[inputs.systemd_units]]
  unittype = "service"
  pattern = "docker* ssh* cron*"
  timeout = "5s"
