volumes:
  nextcloud_db:
  wordpress_db:
  ombi:
  fifos:
  registry:
  mosquitto:
  nextcloud:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mpool/nextcloud/nextcloud
  influxdb-storage:
  grafana-storage:
  otp_data:
  nextcloud_aio_mastercontainer:
    name: nextcloud_aio_mastercontainer
networks:
  mgmt:
    driver: macvlan
    ipam:
      config:
          - subnet: 10.4.0.0/16
            ip_range: 10.4.0.0/18
            aux_addresses:
              shim4: 10.4.0.2
    driver_opts:
      parent: bond0.4
  iot:
    driver: macvlan
    ipam:
      config:
          - subnet: 10.6.0.0/16
            ip_range: 10.6.0.0/18
            aux_addresses:
              shim6: 10.6.0.2
    driver_opts:
      parent: bond0.6
  external:
    driver: macvlan
    ipam:
      config:
          - subnet: 10.2.0.0/16
            ip_range: 10.2.0.0/18
            aux_addresses:
              shim3: 10.2.0.2
    driver_opts:
      parent: bond0.2
  internal:
    driver: macvlan
    ipam:
      config:
          - subnet: 10.3.0.0/16
            ip_range: 10.3.0.0/18
            aux_addresses:
              shim2: 10.3.0.2
    driver_opts:
      parent: bond0.3
  guest:
    driver: macvlan
    ipam:
      config:
          - subnet: 10.5.0.0/16
            ip_range: 10.5.0.0/18
            aux_addresses:
              shim2: 10.5.0.2
    driver_opts:
      parent: bond0.5
  ci:
    # Bridge network for CI jobs - enables DNS resolution to docker-socket-proxy
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
services:
  # Docker socket proxy - filtered access for CI builds
  # Only allows build/image operations, blocks exec/start/stop
  docker-socket-proxy:
    container_name: docker-socket-proxy
    image: tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    networks:
      mgmt:
      ci:
        ipv4_address: 172.28.0.2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Allow build operations
      - BUILD=1
      - IMAGES=1
      - COMMIT=1
      # Allow auth for registry push
      - AUTH=1
      # Deny dangerous operations
      - CONTAINERS=0
      - EXEC=0
      - NETWORKS=0
      - VOLUMES=0
      - POST=1  # Needed for build/push
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:2375/_ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  plex:
    container_name: plex
    ports:
      - "32400/tcp"
    image: plexinc/pms-docker
    networks:
      - external
      - internal
    restart: unless-stopped
    # GPU disabled until NVML driver/library mismatch is fixed
    # runtime: nvidia
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 4G
    environment:
      - TZ=America/New_York
      # - NVIDIA_VISIBLE_DEVICES=all
      # - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
    volumes:
      - /mpool/plex/config:/config
      - /mpool/plex/transcode:/transcode
      - /mpool/plex:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:32400/identity"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
  pihole:
    container_name: pihole
    image: pihole/pihole:2024.07.0
    ports:
      - "443:80"
    networks:
      internal:
        ipv4_address: {{ pihole_ip }}
    environment:
      TZ: America/New_York
      WEBPASSWORD: {{ lookup('env', 'PIHOLE_PASSWORD') }}
    volumes:
      - {{ docker_persistent_data_path }}/pihole/conf:/etc/pihole
      - {{ docker_persistent_data_path }}/pihole/dnsmasq:/etc/dnsmasq.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "dig", "+short", "+norecurse", "+retry=0", "@127.0.0.1", "pi.hole"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  iperf3:
    container_name: iperf3
    image: networkstatic/iperf3
    ports:
      - "5201/tcp"
    networks:
      - internal
    command:
      - "-s"
    restart: unless-stopped
  nginx: 
    image: nginx:1.27-alpine
    container_name: nginx
    networks:
      external:
        ipv4_address: {{ nginx_ip }}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO /dev/null http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - {{ docker_persistent_data_path }}/nginx/conf:/etc/nginx
      - {{ docker_persistent_data_path }}/nginx/webroot:/data/webroot
      - /var/log/nginx:/data/log
      - {{ docker_persistent_data_path }}/certs:/data/certs
  lab_nginx: 
    image: nginx:1.27-alpine
    container_name: lab_nginx
    networks:
      internal:
        ipv4_address: {{ lab_nginx_ip }}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO /dev/null http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - {{ docker_persistent_data_path }}/lab_nginx/conf:/etc/nginx
      - /var/log/lab_nginx:/data/log
      - {{ docker_persistent_data_path }}/certs:/data/certs
  iot_nginx: 
    image: nginx:1.27-alpine
    container_name: iot_nginx
    networks:
      iot:
        ipv4_address: {{ iot_nginx_ip }}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO /dev/null http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - {{ docker_persistent_data_path }}/iot_nginx/conf:/etc/nginx
      - /var/log/iot_nginx:/data/log
      - {{ docker_persistent_data_path }}/certs:/data/certs
  ombi:
    image: linuxserver/ombi
    container_name: ombi
    networks:
      - external
      - internal
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - BASE_URL=/plex-requests
    volumes:
      - ombi:/config
      - /etc/ssl/certs:/etc/ssl/certs
      - /etc/ssl/private:/etc/ssl/private
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3579/api/v1/Status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  nzbget:
    image: linuxserver/nzbget
    container_name: nzbget
    ports:
      - "6789:6789"
    networks:
      - internal
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - {{ docker_persistent_data_path }}/nzbget:/config
      - /mpool/plex/Movies:/movies
      - /mpool/samba_share/nfs:/remote
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6789"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  radarr:
    image: linuxserver/radarr:6.1.0-nightly
    container_name: radarr
    ports:
      - "443:7878"
    networks:
      - internal
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - {{ docker_persistent_data_path }}/radarr:/config
      - /mpool/plex/Movies:/movies
      - /mpool/samba_share/nfs:/remote
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  jackett:
    image: linuxserver/jackett
    container_name: jackett
    ports:
      - "443:9117"
    networks:
      - internal
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - {{ docker_persistent_data_path }}/jackett:/config
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9117/UI/Login"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  sonarr:
    image: linuxserver/sonarr
    container_name: sonarr
    ports:
      - "443:8989"
    networks:
    - internal
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - {{ docker_persistent_data_path }}/sonarr:/config
      - /mpool/plex/TV:/tv
      - /mpool/samba_share/nfs:/remote
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  booksonic:
    image: izderadicka/audioserve
    container_name: audioserve
    ports:
      - "443:3000"
    networks:
      - external
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - AUDIOSERVE_SHARED_SECRET=audiobooks_bepis123
      - VIRTUAL_HOST=audioserve.nkontur.com
      - LETSENCRYPT_HOST=audioserve.nkontur.com
    command: /audiobooks
    volumes:
      - /mpool/audioserve/audiobooks:/audiobooks
      - /mpool/audioserve/data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  influxdb:
    container_name: influxdb
    ports:
      - "443:8086"
    networks:
      internal:
        ipv4_address: {{ influxdb_ip }}
    image: influxdb:latest
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 4G
    volumes:
        - influxdb-storage:/var/lib/influxdb2
        - {{ docker_persistent_data_path }}/influxdb/config:/etc/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD={{ lookup('env', 'INFLUXDB_PASSWORD') }}
      - DOCKER_INFLUXDB_INIT_ORG=homelab
      - DOCKER_INFLUXDB_INIT_BUCKET=metrics
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN={{ lookup('env', 'INFLUXDB_ADMIN_TOKEN') }}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  grafana:
    container_name: grafana
    image: grafana/grafana:latest
    ports:
      - "443:3000"
    networks:
      - internal
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    volumes:
      - grafana-storage:/var/lib/grafana
      - {{ docker_persistent_data_path }}/grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD={{ lookup('env', 'GRAFANA_ADMIN_PASSWORD') }}
      - GF_SERVER_ROOT_URL=https://grafana.lab.nkontur.com
      - GF_USERS_ALLOW_SIGN_UP=false
      - INFLUXDB_TOKEN={{ lookup('env', 'INFLUXDB_ADMIN_TOKEN') }}
      # SMTP for email alerts
      - GF_SMTP_ENABLED=true
      - GF_SMTP_HOST=smtp.gmail.com:587
      - GF_SMTP_USER=konoahko@gmail.com
      - GF_SMTP_PASSWORD={{ lookup('env', 'GRAFANA_SMTP_PASSWORD') }}
      - GF_SMTP_FROM_ADDRESS=konoahko@gmail.com
      - GF_SMTP_FROM_NAME=Grafana Homelab
      - GF_SMTP_STARTTLS_POLICY=MandatoryStartTLS
    depends_on:
      - influxdb
      - loki
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  loki:
    container_name: loki
    image: grafana/loki:3.5.0
    ports:
      - "3100:3100"
    networks:
      internal:
        ipv4_address: {{ loki_ip }}
    restart: unless-stopped
    volumes:
      - {{ docker_persistent_data_path }}/loki/data:/loki
      - {{ docker_persistent_data_path }}/loki/local-config.yaml:/etc/loki/local-config.yaml:ro
    command: -config.file=/etc/loki/local-config.yaml
    # Loki uses default json-file logging to avoid circular dependency
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  gitlab:
    container_name: gitlab
    ports:
      - "22/tcp"
      - "443:80"
    networks:
      - internal
    image: 'gitlab/gitlab-ee:latest'
    restart: unless-stopped
    privileged: true
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc: 65536
    deploy:
      resources:
        limits:
          memory: 24G
        reservations:
          memory: 8G
    volumes:
      - '{{ docker_persistent_data_path }}/gitlab/config:/etc/gitlab'
      - '{{ docker_persistent_data_path }}/gitlab/logs:/var/log/gitlab'
      - '{{ docker_persistent_data_path }}/gitlab/data:/var/opt/gitlab'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/-/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 300s
  deluge:
    container_name: deluge
    ports:
      - "443:8112"
    image: 'lscr.io/linuxserver/deluge:latest'
    restart: unless-stopped
    networks:
      internal:
        ipv4_address: {{ deluge_ip }}
    volumes:
      - '{{ docker_persistent_data_path }}/deluge:/config'
      - '/mpool/samba_share/nfs:/downloads'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8112"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  bitwarden:
    container_name: bitwarden
    ports:
      - "443:80"
    image: 'vaultwarden/server:latest'
    restart: unless-stopped
    networks:
      - external
    volumes:
      - '{{ docker_persistent_data_path }}/bitwarden/data/:/data/'
    env_file:
      - '{{ docker_persistent_data_path }}/bitwarden/global.override.env'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  blog:
    image: wordpress
    container_name: wordpress
    ports:
      - "443:80"
    networks:
      - external
    environment:
      WORDPRESS_DB_HOST: wordpress_db
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: {{ lookup('env', 'WORDPRESS_DB_PASSWORD') }}
      WORDPRESS_DB_NAME: wordpress
    volumes:
      - {{ docker_persistent_data_path }}/wordpress/html:/var/www/html
      - {{ docker_persistent_data_path }}/wordpress/config:/etc/wordpress
    restart: unless-stopped
  wordpress_db:
    image: mysql
    container_name: wordpress_db
    networks:
      - external
    restart: unless-stopped
    cap_add:
      - SYS_NICE  # CAP_SYS_NICE
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G
    environment:
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: {{ lookup('env', 'WORDPRESS_DB_PASSWORD') }}
      MYSQL_ROOT_PASSWORD: {{ lookup('env', 'WORDPRESS_DB_PASSWORD') }}
    volumes:
      - wordpress_db:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p{{ lookup('env', 'WORDPRESS_DB_PASSWORD') }}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  diagram:
    container_name: diagram
    ports:
      - "443:8080"
    networks:
      internal:
    image: jgraph/drawio
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  watchtower:
    container_name: watchtower
    restart: unless-stopped
    networks:
      internal:
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 3600
  homeassistant:
    container_name: homeassistant
    networks:
      - internal
      - iot
      - external
    depends_on:
      - plex
      - amcrest2mqtt
      - snapserver
    ports:
      - "443:8123"
    devices: 
      - "/dev/serial/by-id/usb-Prolific_Technology_Inc._USB-Serial_Controller_ETDRb11A920-if00-port0:/dev/ttyUSB0"
      - "/dev/serial/by-id/usb-Prolific_Technology_Inc._USB-Serial_Controller-if00-port0:/dev/ttyUSB1"
    image: "homeassistant/home-assistant:2025.12"
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G
    volumes:
      - "{{ docker_persistent_data_path }}/homeassistant:/config"
      - /etc/localtime:/etc/localtime:ro
    command: ["/bin/bash", "-c", "ip route del default; ip route add default via 10.3.0.1 dev eth1; /init"]
    cap_add:
      - NET_ADMIN # So we can override default route
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/api/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
  snapserver:
    container_name: snapserver
    hostname: snapserver
    networks:
      iot:
        ipv4_address: {{ snapserver_address }}
    image: "registry.lab.nkontur.com/snapcast"
    volumes:
      - "{{ docker_persistent_data_path }}/snapserver/snapserver.conf:/etc/snapserver.conf"
      - "{{ docker_persistent_data_path }}/snapserver/server.json:/root/.config/snapserver/server.json"
      - "/tmp/snapfifo:/tmp/snapfifo"
      - "fifos:/tmp/fifo"
    restart: unless-stopped
    devices:
      - "/dev/snd"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 1704 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  snapclient_office:
    container_name: snapclient_office
    networks:
      iot:
    image: "registry.lab.nkontur.com/snapclient"
    restart: unless-stopped
    devices:
      - "/dev/snd"
    command:
      - "-h"
      - {{ snapserver_address }}
      - "-s"
      - "plughw:CARD=Office,DEV=0"
      - "--hostID"
      - "office"
  snapclient_global:
    container_name: snapclient_global
    networks:
      iot:
    image: "registry.lab.nkontur.com/snapclient"
    restart: unless-stopped
    devices:
      - "/dev/snd"
    command:
      - "-h"
      - {{ snapserver_address }}
      - "-s"
      - "plughw:CARD=Global,DEV=0"
      - "--hostID"
      - "global"
  snapclient_kitchen:
    container_name: snapclient_kitchen
    networks:
      iot:
    image: "registry.lab.nkontur.com/snapclient"
    restart: unless-stopped
    devices:
      - "/dev/snd"
    command:
      - "-h"
      - {{ snapserver_address }}
      - "-s"
      - "plughw:CARD=Kitchen,DEV=0"
      - "--hostID"
      - "kitchen"
  snapclient_main_bedroom:
    container_name: snapclient_main_bedroom
    networks:
      iot:
    image: "registry.lab.nkontur.com/snapclient"
    restart: unless-stopped
    devices:
      - "/dev/snd"
    command:
      - "-h"
      - {{ snapserver_address }}
      - "-s"
      - "plughw:CARD=Main_Bedroom,DEV=0"
      - "--hostID"
      - "main_bedroom"
  snapclient_main_bathroom:
    container_name: snapclient_main_bathroom
    networks:
      iot:
    image: "registry.lab.nkontur.com/snapclient"
    restart: unless-stopped
    devices:
      - "/dev/snd"
    command:
      - "-h"
      - {{ snapserver_address }}
      - "-s"
      - "plughw:CARD=Main_Bathroom,DEV=0"
      - "--hostID"
      - "main_bathroom"
  snapclient_guest_bathroom:
    container_name: snapclient_guest_bathroom
    networks:
      iot:
    image: "registry.lab.nkontur.com/snapclient"
    restart: unless-stopped
    devices:
      - "/dev/snd"
    command:
      - "-h"
      - {{ snapserver_address }}
      - "-s"
      - "plughw:CARD=Guest_Bathroom,DEV=0"
      - "--hostID"
      - "guest_bathroom"
  snapclient_guest_bedroom:
    container_name: snapclient_guest_bedroom
    networks:
      iot:
    image: "registry.lab.nkontur.com/snapclient"
    restart: unless-stopped
    devices:
      - "/dev/snd"
    command:
      - "-h"
      - {{ snapserver_address }}
      - "-s"
      - "plughw:CARD=Guest_Bedroom,DEV=0"
      - "--hostID"
      - "guest_bedroom"
  registry:
    container_name: registry
    restart: unless-stopped
    image: registry:2
    networks:
      mgmt:
        ipv4_address: {{ registry_address }}
    environment:
      REGISTRY_HTTP_TLS_CERTIFICATE: /certs/nkontur.com/live/iot.lab.nkontur.com-0003/cert.pem
      REGISTRY_HTTP_TLS_KEY: /certs/nkontur.com/live/iot.lab.nkontur.com-0003/privkey.pem
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: Registry Realm
      REGISTRY_HTTP_ADDR: "0.0.0.0:443"
      VIRTUAL_HOST: registry.lab.nkontur.com
      LETSENCRYPT_HOST: registry.lab.nkontur.com
    volumes:
      - registry:/var/lib/registry
      - {{ docker_persistent_data_path }}/registry/auth:/auth
      - {{ docker_persistent_data_path }}/certs:/certs
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "--no-check-certificate", "https://localhost:443/v2/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  mosquitto:
    container_name: mosquitto
    image: eclipse-mosquitto
    restart: unless-stopped
    networks:
      iot:
        ipv4_address: {{ mosquitto_address }}
    volumes:
      - "{{ docker_persistent_data_path }}/mqtt/conf:/mosquitto/config"
      - mosquitto:/mosquitto/data
      - "{{ docker_persistent_data_path }}/certs:/mosquitto/certs"
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  amcrest2mqtt:
    container_name: amcrest2mqtt
    image: registry.lab.nkontur.com/amcrest2mqtt:latest
    depends_on:
      - mosquitto
    restart: unless-stopped
    networks:
      iot:
    volumes:
      - "{{ docker_persistent_data_path }}/certs:/certs"
    environment:
      AMCREST_HOST: 10.6.128.9
      AMCREST_PASSWORD: {{ lookup('env', 'DOORBELL_PASS') }}
      MQTT_HOST: "mqtt.lab.nkontur.com"
      MQTT_USERNAME: mosquitto
      MQTT_PASSWORD: {{ lookup('env', 'MQTT_PASS') }}
      HOME_ASSISTANT: "true"
      MQTT_TLS_ENABLED: "true"
      MQTT_TLS_CA_CERT: "/etc/ssl/certs/ca-cert-ISRG_Root_X1.pem"
      MQTT_TLS_CERT: "/certs/nkontur.com/live/iot.lab.nkontur.com-0003/cert.pem"
      MQTT_TLS_KEY: "/certs/nkontur.com/live/iot.lab.nkontur.com-0003/privkey.pem"
      STORAGE_POLL_INTERVAL: 0

  ambientweather:
    image: ghcr.io/neilenns/ambientweather2mqtt:latest
    restart: unless-stopped
    container_name: ambientweather
    networks:
      iot:
        ipv4_address: {{ weather_mqtt_bridge_ip }}
    environment:
      STATION_MAC_ADDRESS: {{ weather_station_mac }}
      MQTT_SERVER: "mqtts://mqtt.lab.nkontur.com:1883"
      TZ: America/New_York
      PORT: 8080
      MQTT_USERNAME: mosquitto
      MQTT_PASSWORD: {{ lookup('env', 'MQTT_PASS') }}
      MQTT_REJECT_UNAUTHORIZED: "false"
  zigbee2mqtt:
    container_name: zigbee2mqtt
    restart: unless-stopped
    image: koenkk/zigbee2mqtt
    depends_on:
      - mosquitto
    networks:
      iot:
    ports:
      - 8081:8080
    volumes:
      - "{{ docker_persistent_data_path }}/zigbee2mqtt:/app/data"
    environment:
      - TZ=America/New_York
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  paperless-ngx:
    image: lscr.io/linuxserver/paperless-ngx:latest
    container_name: paperless-ngx
    networks:
      internal:
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - PAPERLESS_URL=https://paperless-ngx.lab.nkontur.com
    volumes:
      - "{{ docker_persistent_data_path }}/paperless:/config"
      - "/mpool/nextcloud/paperless:/data"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  mopidy:
    image: wernight/mopidy
    container_name: mopidy
    networks:
      iot:
        ipv4_address: {{ mopidy_address }}
    environment:
      - TZ=America/New_York
    volumes:
      - "{{ docker_persistent_data_path }}/mopidy/media:/var/lib/mopidy/media:ro"
      - "{{ docker_persistent_data_path }}/mopidy/local:/var/lib/mopidy/local"
      - "{{ docker_persistent_data_path }}/mopidy/playlists:/var/lib/mopidy/playlists"
      - "{{ docker_persistent_data_path }}/mopidy/config/mopidy.conf:/config/mopidy.conf"
      - "fifos:/tmp/fifo"
    devices:
      - "/dev/snd"
    ports:
      - "443:6680"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6680"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  nextcloud_db:
    image: mariadb
    container_name: nextcloud_database
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    restart: unless-stopped
    networks:
      - external
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G
    volumes:
      - nextcloud_db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD={{ lookup('env', 'NEXTCLOUD_DB_PASSWORD') }}
      - MYSQL_PASSWORD={{ lookup('env', 'NEXTCLOUD_DB_PASSWORD') }}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  nextcloud:
    image: nextcloud:32.0.1
    container_name: nextcloud
    networks:
      - external
    hostname: nkontur.com
    ports:
      - "443:80"
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G
    volumes:
      - nextcloud:/data
#      - {{ docker_persistent_data_path }}/nextcloud/config:/var/www/html/config
#      - {{ docker_persistent_data_path }}/nextcloud/mpm_prefork.conf:/etc/apache2/mods-available/mpm_prefork.conf
#      - {{ docker_persistent_data_path }}/nextcloud/config/php.ini:/usr/local/etc/php/php.ini
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/status.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    ports:
      - "443:7878"
    networks:
      - internal
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - {{ docker_persistent_data_path }}/prowlarr:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  moltbot-gateway:
    image: registry.lab.nkontur.com/moltbot-gateway:latest
    container_name: moltbot-gateway
    restart: unless-stopped
    networks:
      internal:
      iot:
      mgmt:
        ipv4_address: {{ moltbot_gateway_ip }}
    ports:
      - "18789:18789"
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 4G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    environment:
      - TZ=America/New_York
      # Core moltbot configuration
      - OPENAI_API_KEY={{ lookup('env', 'OPENAI_API_KEY') }}
      - CLAWDBOT_GATEWAY_TOKEN={{ lookup('env', 'MOLTBOT_GATEWAY_TOKEN') }}
      - TELEGRAM_BOT_TOKEN={{ lookup('env', 'MOLTBOT_TELEGRAM_TOKEN') }}
      - HASS_URL=http://homeassistant:8123
      - HASS_TOKEN={{ lookup('env', 'HASS_TOKEN') }}
      - GITLAB_TOKEN={{ lookup('env', 'MOLTBOT_GITLAB_TOKEN') }}
      # Media management APIs (internal network)
      - RADARR_URL=http://radarr:7878
      - RADARR_API_KEY={{ lookup('env', 'RADARR_API_KEY') }}
      - SONARR_URL=http://sonarr:8989
      - SONARR_API_KEY={{ lookup('env', 'SONARR_API_KEY') }}
      - PROWLARR_URL=http://prowlarr:9696
      - PROWLARR_API_KEY={{ lookup('env', 'PROWLARR_API_KEY') }}
      - PLEX_URL=http://plex:32400
      - PLEX_TOKEN={{ lookup('env', 'PLEX_TOKEN') }}
      - OMBI_URL=http://ombi:3579
      - OMBI_API_KEY={{ lookup('env', 'OMBI_API_KEY') }}
      # Download clients
      - NZBGET_URL=http://nzbget:6789
      - NZBGET_USERNAME={{ lookup('env', 'NZBGET_USERNAME') }}
      - NZBGET_PASSWORD={{ lookup('env', 'NZBGET_PASSWORD') }}
      - DELUGE_URL=http://deluge:8112
      - DELUGE_PASSWORD={{ lookup('env', 'DELUGE_PASSWORD') }}
      # Document management
      - PAPERLESS_URL=http://paperless-ngx:8000
      - PAPERLESS_TOKEN={{ lookup('env', 'PAPERLESS_TOKEN') }}
      # Metrics/monitoring
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN={{ lookup('env', 'INFLUXDB_TOKEN') }}
      # Grafana API access
      - GRAFANA_URL={{ grafana_url }}
      - GRAFANA_TOKEN={{ grafana_token }}
      # Tailscale API access
      - TAILSCALE_API_TOKEN={{ lookup('env', 'TAILSCALE_API_TOKEN') }}
      # IPMI access for server management
      - IPMI_USER={{ lookup('env', 'IPMI_USER') }}
      - IPMI_PASSWORD={{ lookup('env', 'IPMI_PASSWORD') }}
    volumes:
      - {{ docker_persistent_data_path }}/moltbot/data:/home/node/.moltbot
      - {{ docker_persistent_data_path }}/moltbot/data:/home/node/.clawdbot
      - {{ docker_persistent_data_path }}/moltbot/mcporter:/home/node/.mcporter
      - {{ docker_persistent_data_path }}/moltbot/workspace:/home/node/clawd
      - /var/run/docker.sock:/var/run/docker.sock
    command: ["node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789"]
