[
    {
        "directive": "server",
        "line": 2,
        "args": [],
        "block": [
            {
                "directive": "server_name",
                "line": 3,
                "args": [
                    "www.nkontur.com",
                    "nkontur.com"
                ]
            },
            {
                "directive": "listen",
                "line": 4,
                "args": [
                    "443",
                    "ssl",
                    "http2"
                ]
            },
            {
                "directive": "listen",
                "line": 5,
                "args": [
                    "[::]:443",
                    "ssl",
                    "http2"
                ]
            },
            {
                "directive": "include",
                "line": 6,
                "args": [
                    "ssl_config"
                ],
                "includes": []
            },
            {
                "directive": "limit_req",
                "line": 7,
                "args": [
                    "zone=general",
                    "burst=20",
                    "nodelay"
                ]
            },
            {
                "directive": "root",
                "line": 8,
                "args": [
                    "/data/webroot/nkontur.com"
                ]
            },
            {
                "directive": "index",
                "line": 9,
                "args": [
                    "index.html"
                ]
            },
            {
                "directive": "location",
                "line": 10,
                "args": [
                    "/plex/"
                ],
                "block": [
                    {
                        "directive": "proxy_pass",
                        "line": 11,
                        "args": [
                            "http://plex:32400/"
                        ]
                    },
                    {
                        "directive": "client_max_body_size",
                        "line": 12,
                        "args": [
                            "10m"
                        ]
                    },
                    {
                        "directive": "client_body_buffer_size",
                        "line": 13,
                        "args": [
                            "128k"
                        ]
                    },
                    {
                        "directive": "proxy_bind",
                        "line": 14,
                        "args": [
                            "$server_addr"
                        ]
                    },
                    {
                        "directive": "proxy_buffers",
                        "line": 15,
                        "args": [
                            "32",
                            "4k"
                        ]
                    },
                    {
                        "directive": "proxy_cache_bypass",
                        "line": 16,
                        "args": [
                            "$cookie_session"
                        ]
                    },
                    {
                        "directive": "proxy_connect_timeout",
                        "line": 17,
                        "args": [
                            "240"
                        ]
                    },
                    {
                        "directive": "proxy_hide_header",
                        "line": 18,
                        "args": [
                            "X-Frame-Options"
                        ]
                    },
                    {
                        "directive": "proxy_http_version",
                        "line": 19,
                        "args": [
                            "1.1"
                        ]
                    },
                    {
                        "directive": "proxy_no_cache",
                        "line": 20,
                        "args": [
                            "$cookie_session"
                        ]
                    },
                    {
                        "directive": "proxy_read_timeout",
                        "line": 21,
                        "args": [
                            "240"
                        ]
                    },
                    {
                        "directive": "proxy_redirect",
                        "line": 22,
                        "args": [
                            "http://",
                            "$scheme://"
                        ]
                    },
                    {
                        "directive": "proxy_send_timeout",
                        "line": 23,
                        "args": [
                            "240"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "line": 24,
                        "args": [
                            "Connection",
                            "upgrade"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "line": 25,
                        "args": [
                            "Host",
                            "$host"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "line": 26,
                        "args": [
                            "X-Real-IP",
                            "$remote_addr"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "line": 27,
                        "args": [
                            "X-Forwarded-For",
                            "$proxy_add_x_forwarded_for"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "line": 28,
                        "args": [
                            "X-Forwarded-Host",
                            "$server_name"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "line": 29,
                        "args": [
                            "X-Forwarded-Proto",
                            "https"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "line": 30,
                        "args": [
                            "X-Forwarded-Ssl",
                            "on"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "line": 31,
                        "args": [
                            "Upgrade",
                            "$http_upgrade"
                        ]
                    },
                    {
                        "directive": "send_timeout",
                        "line": 32,
                        "args": [
                            "5m"
                        ]
                    }
                ]
            },
            {
                "directive": "if",
                "line": 34,
                "args": [
                    "$http_referer",
                    "~",
                    "/plex/"
                ],
                "block": [
                    {
                        "directive": "rewrite",
                        "line": 35,
                        "args": [
                            "^/media/(.*)",
                            "/plex/media/$1?",
                            "redirect"
                        ]
                    }
                ]
            },
            {
                "directive": "rewrite",
                "line": 37,
                "args": [
                    "^/web/(.*)",
                    "/plex/web/$1?",
                    "redirect"
                ]
            },
            {
                "directive": "rewrite",
                "line": 38,
                "args": [
                    "^/media/(.*)",
                    "/plex/media/$1?",
                    "redirect"
                ]
            },
            {
                "directive": "if",
                "line": 40,
                "args": [
                    "$http_referer",
                    "~*",
                    "/plex-requests/"
                ],
                "block": [
                    {
                        "directive": "rewrite",
                        "line": 41,
                        "args": [
                            "^/dist/(.*)",
                            "$scheme://$host/plex-requests/dist/$1",
                            "permanent"
                        ]
                    }
                ]
            },
            {
                "directive": "location",
                "line": 44,
                "args": [
                    "/plex-requests/"
                ],
                "block": [
                    {
                        "directive": "proxy_pass",
                        "line": 45,
                        "args": [
                            "http://ombi:3579/plex-requests/"
                        ]
                    }
                ]
            },
            {
                "directive": "location",
                "line": 48,
                "args": [
                    "/net-map"
                ],
                "block": [
                    {
                        "directive": "alias",
                        "line": 49,
                        "args": [
                            "/data/webroot/nkontur.com/net-map"
                        ]
                    },
                    {
                        "directive": "index",
                        "line": 50,
                        "args": [
                            "index.html"
                        ]
                    }
                ]
            },
            {
                "directive": "location",
                "line": 51,
                "args": [
                    "/images/"
                ],
                "block": [
                    {
                        "directive": "alias",
                        "line": 52,
                        "args": [
                            "/data/webroot/html/images/"
                        ]
                    }
                ]
            },
            {
                "directive": "location",
                "line": 54,
                "args": [
                    "/files/"
                ],
                "block": [
                    {
                        "directive": "alias",
                        "line": 55,
                        "args": [
                            "/data/webroot/html/files/"
                        ]
                    }
                ]
            },
            {
                "directive": "location",
                "line": 58,
                "args": [
                    "/"
                ],
                "block": [
                    {
                        "directive": "try_files",
                        "line": 54,
                        "args": [
                            "$uri",
                            "$uri.html",
                            "$uri/",
                            "=404"
                        ]
                    }
                ]
            }
        ]
    },
    {
        "directive": "server",
        "args": [],
        "block": [
            {
                "directive": "listen",
                "args": [
                    "443",
                    "ssl",
                    "http2"
                ]
            },
            {
                "directive": "server_name",
                "args": [
                    "jit-webhook.nkontur.com"
                ]
            },
            {
                "directive": "include",
                "args": [
                    "ssl_config"
                ],
                "includes": []
            },
            {
                "directive": "location",
                "args": [
                    "/telegram/webhook"
                ],
                "block": [
                    {
                        "directive": "allow",
                        "args": [
                            "91.108.56.0/22"
                        ]
                    },
                    {
                        "directive": "allow",
                        "args": [
                            "91.108.4.0/22"
                        ]
                    },
                    {
                        "directive": "allow",
                        "args": [
                            "91.108.8.0/22"
                        ]
                    },
                    {
                        "directive": "allow",
                        "args": [
                            "91.108.16.0/22"
                        ]
                    },
                    {
                        "directive": "allow",
                        "args": [
                            "91.108.12.0/22"
                        ]
                    },
                    {
                        "directive": "allow",
                        "args": [
                            "149.154.160.0/20"
                        ]
                    },
                    {
                        "directive": "allow",
                        "args": [
                            "91.105.192.0/23"
                        ]
                    },
                    {
                        "directive": "allow",
                        "args": [
                            "91.108.20.0/22"
                        ]
                    },
                    {
                        "directive": "allow",
                        "args": [
                            "185.76.151.0/24"
                        ]
                    },
                    {
                        "directive": "deny",
                        "args": [
                            "all"
                        ]
                    },
                    {
                        "directive": "resolver",
                        "args": [
                            "127.0.0.11"
                        ]
                    },
                    {
                        "directive": "set",
                        "args": [
                            "$backend",
                            "http://jit-approval-svc:8080"
                        ]
                    },
                    {
                        "directive": "proxy_pass",
                        "args": [
                            "$backend"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "args": [
                            "Host",
                            "$host"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "args": [
                            "X-Real-IP",
                            "$remote_addr"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "args": [
                            "X-Forwarded-For",
                            "$proxy_add_x_forwarded_for"
                        ]
                    },
                    {
                        "directive": "proxy_set_header",
                        "args": [
                            "X-Forwarded-Proto",
                            "$scheme"
                        ]
                    }
                ]
            },
            {
                "directive": "location",
                "args": [
                    "/"
                ],
                "block": [
                    {
                        "directive": "return",
                        "args": [
                            "404"
                        ]
                    }
                ]
            }
        ]
    }
]
