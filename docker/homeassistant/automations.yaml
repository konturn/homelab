# Home Assistant Automations
# Practical, high-value automations for the homelab

# =============================================================================
# DOOR-BASED LIGHTING
# Automatically turn on lights when doors open, turn off after timeout
# =============================================================================

# Main Bathroom - Door opens, turn on light
- id: main_bathroom_door_light_on
  alias: "Main Bathroom - Door Light On"
  description: "Turn on main bathroom light when door opens"
  trigger:
    - platform: state
      entity_id: binary_sensor.main_bathroom_door_sensor_access_control_window_door_is_open
      from: 'off'
      to: 'on'
  condition:
    - condition: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: 10  # Only when sun is low (evening/night/early morning)
  action:
    - service: light.turn_on
      target:
        entity_id: light.main_bathroom
      data:
        brightness: 200  # Comfortable brightness

# Main Bathroom - Door closes, turn off light after delay
- id: main_bathroom_door_light_off
  alias: "Main Bathroom - Door Light Off"
  description: "Turn off main bathroom light 5 minutes after door closes"
  trigger:
    - platform: state
      entity_id: binary_sensor.main_bathroom_door_sensor_access_control_window_door_is_open
      from: 'on'
      to: 'off'
      for: '00:05:00'
  action:
    - service: light.turn_off
      target:
        entity_id: light.main_bathroom

# Main Bedroom - Door opens, turn on light
- id: main_bedroom_door_light_on
  alias: "Main Bedroom - Door Light On"
  description: "Turn on main bedroom lights when door opens at night"
  trigger:
    - platform: state
      entity_id: binary_sensor.main_bedroom_door_sensor_access_control_window_door_is_open
      from: 'off'
      to: 'on'
  condition:
    - condition: numeric_state
      entity_id: sun.sun
      attribute: elevation
      below: 0  # Only at night
  action:
    - service: light.turn_on
      target:
        entity_id: light.main_bedroom
      data:
        brightness: 100  # Dim for nighttime

# Office - Door opens, turn on lights during work hours
- id: office_door_light_on
  alias: "Office - Door Light On"
  description: "Turn on office lights when door opens during work hours"
  trigger:
    - platform: state
      entity_id: binary_sensor.office_door_sensor_access_control_window_door_is_open
      from: 'off'
      to: 'on'
  condition:
    - condition: time
      after: '07:00:00'
      before: '22:00:00'
  action:
    - service: light.turn_on
      target:
        entity_id: light.office
      data:
        brightness: 255  # Full brightness for work

# Office - Auto-off after 30 minutes of no motion
- id: office_auto_off
  alias: "Office - Auto Off No Motion"
  description: "Turn off office lights after 30 minutes of no motion"
  trigger:
    - platform: state
      entity_id: binary_sensor.office_sensor_home_security_motion_detection
      from: 'on'
      to: 'off'
      for: '00:30:00'
  action:
    - service: light.turn_off
      target:
        entity_id: light.office

# =============================================================================
# MOVIE MODE
# One-click setup for movie watching: dim lights + projector + receiver
# =============================================================================

- id: movie_mode_activate
  alias: "Movie Mode - Activate"
  description: "Activate movie mode: dim lights, turn on projector and receiver"
  trigger:
    - platform: state
      entity_id: input_boolean.movie_mode
      from: 'off'
      to: 'on'
  action:
    - parallel:
        # Dim all lights to 10%
        - service: light.turn_on
          target:
            entity_id: 
              - light.living_room
              - light.kitchen
              - light.main_bedroom
          data:
            brightness: 25  # 10% brightness
        # Turn off non-essential lights
        - service: light.turn_off
          target:
            entity_id:
              - light.office
              - light.guest_bedroom
              - light.hallway
        # Turn on projector
        - service: media_player.turn_on
          target:
            entity_id: media_player.projector_lab_nkontur_com
        # Switch receiver to correct input (assuming Shield TV)
        - service: media_player.select_source
          target:
            entity_id: media_player.denon_avr_x2700h  # Adjust entity name as needed
          data:
            source: "Game"  # Shield TV input
        # Set bass boost for movies
        - service: input_boolean.turn_on
          target:
            entity_id: input_boolean.bass_boost
        - delay:
            seconds: 2
        - service: rest_command.bass_boost
        - service: rest_command.bass_boost_2

# Movie Mode - Deactivate
- id: movie_mode_deactivate
  alias: "Movie Mode - Deactivate"
  description: "Deactivate movie mode: restore normal lighting"
  trigger:
    - platform: state
      entity_id: input_boolean.movie_mode
      from: 'on'
      to: 'off'
  action:
    - parallel:
        # Restore normal lighting
        - service: light.turn_on
          target:
            entity_id: 
              - light.living_room
              - light.kitchen
          data:
            brightness: 200  # Normal brightness
        # Turn off projector
        - service: media_player.turn_off
          target:
            entity_id: media_player.projector_lab_nkontur_com
        # Turn off bass boost
        - service: input_boolean.turn_off
          target:
            entity_id: input_boolean.bass_boost
        - delay:
            seconds: 2
        - service: rest_command.bass_boost
        - service: rest_command.bass_boost_2

# =============================================================================
# AIR QUALITY ALERTS
# Monitor CO2 and PM2.5 levels, send notifications when unhealthy
# =============================================================================

# Kitchen CO2 Alert
- id: kitchen_co2_alert
  alias: "Kitchen - High CO2 Alert"
  description: "Send notification when kitchen CO2 exceeds 1000ppm"
  trigger:
    - platform: numeric_state
      entity_id: sensor.kitchen_sensor_carbon_dioxide
      above: 1000
      for: '00:05:00'  # Sustained for 5 minutes
  action:
    - service: notify.persistent_notification
      data:
        title: "⚠️ High CO2 - Kitchen"
        message: "CO2 level is {{ states('sensor.kitchen_sensor_carbon_dioxide') }}ppm. Consider opening windows or running ventilation."
    # Optionally play sound via Snapcast
    - service: shell_command.sound_doorbell  # Reuse doorbell sound as alert

# Bedroom CO2 Alert
- id: bedroom_co2_alert
  alias: "Bedroom - High CO2 Alert" 
  description: "Send notification when bedroom CO2 exceeds 1000ppm"
  trigger:
    - platform: numeric_state
      entity_id: sensor.bedroom_sensor_carbon_dioxide
      above: 1000
      for: '00:05:00'
  action:
    - service: notify.persistent_notification
      data:
        title: "⚠️ High CO2 - Bedroom"
        message: "CO2 level is {{ states('sensor.bedroom_sensor_carbon_dioxide') }}ppm. Consider opening windows for fresh air."

# Kitchen PM2.5 Alert (unhealthy level > 35 μg/m³)
- id: kitchen_pm25_alert
  alias: "Kitchen - High PM2.5 Alert"
  description: "Send notification when kitchen PM2.5 is unhealthy"
  trigger:
    - platform: numeric_state
      entity_id: sensor.kitchen_sensor_particulate_matter_2_5
      above: 35
      for: '00:10:00'  # Sustained for 10 minutes
  action:
    - service: notify.persistent_notification
      data:
        title: "⚠️ High PM2.5 - Kitchen"
        message: "PM2.5 level is {{ states('sensor.kitchen_sensor_particulate_matter_2_5') }}μg/m³. Check air filters or cooking ventilation."

# Bedroom PM2.5 Alert
- id: bedroom_pm25_alert
  alias: "Bedroom - High PM2.5 Alert"
  description: "Send notification when bedroom PM2.5 is unhealthy"
  trigger:
    - platform: numeric_state
      entity_id: sensor.bedroom_sensor_particulate_matter_2_5
      above: 35
      for: '00:10:00'
  action:
    - service: notify.persistent_notification
      data:
        title: "⚠️ High PM2.5 - Bedroom"
        message: "PM2.5 level is {{ states('sensor.bedroom_sensor_particulate_matter_2_5') }}μg/m³. Consider running air purifier."

# =============================================================================
# GOODNIGHT ROUTINE
# One command to prepare the house for bedtime
# =============================================================================

- id: goodnight_routine
  alias: "Goodnight Routine"
  description: "Prepare house for bedtime: lights off, doors locked, lower thermostat"
  trigger:
    - platform: state
      entity_id: input_boolean.goodnight_mode
      from: 'off'
      to: 'on'
  action:
    - parallel:
        # Turn off all lights except main bedroom (dim)
        - service: light.turn_off
          target:
            entity_id:
              - light.living_room
              - light.kitchen
              - light.office
              - light.guest_bedroom
              - light.hallway
              - light.main_bathroom
        # Dim main bedroom light
        - service: light.turn_on
          target:
            entity_id: light.main_bedroom
          data:
            brightness: 50  # Very dim for bedtime
        # Turn off entertainment systems
        - service: media_player.turn_off
          target:
            entity_id:
              - media_player.projector_lab_nkontur_com
              - media_player.denon_avr_x2700h
              - media_player.shield_tv
        # Turn off PC
        - service: switch.turn_off
          target:
            entity_id: switch.wake_on_lan
        # Set movie mode and bass boost off
        - service: input_boolean.turn_off
          target:
            entity_id:
              - input_boolean.movie_mode
              - input_boolean.bass_boost
        # Lock doors if available (assuming smart locks exist)
        # - service: lock.lock
        #   target:
        #     entity_id: lock.front_door
        # Lower thermostat if available
        # - service: climate.set_temperature
        #   target:
        #     entity_id: climate.main_thermostat
        #   data:
        #     temperature: 68

# Auto-reset goodnight mode in the morning
- id: goodnight_auto_reset
  alias: "Goodnight - Auto Reset Morning"
  description: "Automatically turn off goodnight mode in the morning"
  trigger:
    - platform: time
      at: '07:00:00'
  condition:
    - condition: state
      entity_id: input_boolean.goodnight_mode
      state: 'on'
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.goodnight_mode