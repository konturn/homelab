# =============================================================================
# CI Pipeline - Docker-Based, Zero Runtime Dependencies
# =============================================================================
# Target: Total pipeline time < 2 minutes
#
# Strategy:
# - Custom Docker image with ALL deps pre-installed (pip packages, ansible roles)
# - Jobs only set up SSH and run playbooks - no pip install, no ansible-galaxy
# - Image rebuilt automatically when deps change (via build stage)
# - Registry: GitLab Container Registry (registry.lab.nkontur.com)
# - Path-based rules - jobs only run when relevant files change
# - DAG pipelines - deploy jobs start immediately after their validation
# - Interruptible validation - new commits cancel in-progress MR pipelines
#
# Pipeline structure (DAG visualization):
#
#   [build:ci-image] (only when deps change)
#          │
#          v
#   router:validate ──► router:deploy
#   zwave:validate ───► zwave:deploy
#   satellite-2:validate ──► satellite-2:deploy
#
# To force image rebuild: increment CI_IMAGE_VERSION
# =============================================================================

# =============================================================================
# Workflow Configuration
# =============================================================================
workflow:
  auto_cancel:
    on_new_commit: interruptible

variables:
  CI_IMAGE_VERSION: "1"
  CI_IMAGE: "${CI_REGISTRY_IMAGE}/ci:${CI_IMAGE_VERSION}"
  ANSIBLE_HOST_KEY_CHECKING: "False"
  ANSIBLE_PIPELINING: "True"

# =============================================================================
# Path-based change detection
# =============================================================================
# Only run jobs when relevant files have changed

.router_changes:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - ansible/router.yml
        - ansible/inventory.yml
        - ansible/roles/configure-base/**/*
        - ansible/roles/configure-docker/**/*
        - ansible/roles/configure-router-network/**/*
        - ansible/roles/configure-wireguard/**/*
        - ansible/roles/configure-notifications/**/*
        - docker/docker-compose.yml
        - docker/**/*
        - networking/**/*
        - requirements.txt
        - ansible/requirements.yml
        - .gitlab-ci.yml

.zwave_changes:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - ansible/zwave.yml
        - ansible/inventory.yml
        - ansible/roles/configure-zwave/**/*
        - ansible/roles/configure-snapclient/**/*
        - docker/docker-compose-zwave.yml
        - requirements.txt
        - ansible/requirements.yml
        - .gitlab-ci.yml

.satellite2_changes:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - ansible/satellite-2.yml
        - ansible/inventory.yml
        - ansible/roles/configure-satellite/**/*
        - requirements.txt
        - ansible/requirements.yml
        - .gitlab-ci.yml

.router_deploy_rules:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - ansible/router.yml
        - ansible/inventory.yml
        - ansible/roles/configure-base/**/*
        - ansible/roles/configure-docker/**/*
        - ansible/roles/configure-router-network/**/*
        - ansible/roles/configure-wireguard/**/*
        - ansible/roles/configure-notifications/**/*
        - docker/docker-compose.yml
        - docker/**/*
        - networking/**/*

.zwave_deploy_rules:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - ansible/zwave.yml
        - ansible/inventory.yml
        - ansible/roles/configure-zwave/**/*
        - ansible/roles/configure-snapclient/**/*
        - docker/docker-compose-zwave.yml

.satellite2_deploy_rules:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - ansible/satellite-2.yml
        - ansible/inventory.yml
        - ansible/roles/configure-satellite/**/*

# =============================================================================
# Job Templates
# =============================================================================
.interruptible:
  interruptible: true

stages:
  - build-image
  - validate
  - deploy

# =============================================================================
# Build Stage - Rebuild CI image when dependencies change
# =============================================================================
build:ci-image:
  stage: build-image
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    - docker build -t "$CI_IMAGE" -f ci/Dockerfile .
    - docker push "$CI_IMAGE"
  rules:
    # Build on main when deps files change
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - requirements.txt
        - ansible/requirements.yml
        - ci/Dockerfile
    # Build on MR when deps files change (for testing)
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - requirements.txt
        - ansible/requirements.yml
        - ci/Dockerfile
    # Manual trigger
    - when: manual
      allow_failure: true

# =============================================================================
# Base job - minimal setup (just SSH keys)
# =============================================================================
.ansible:
  image: $CI_IMAGE
  before_script:
    - mkdir -p ~/.ssh
    - cp ansible/known_hosts ~/.ssh/known_hosts
    - echo ${ROUTER_PRIVATE_KEY_BASE64}|base64 -d > tmp && chmod 600 tmp

# =============================================================================
# Validation Stage - Runs in parallel on MRs
# =============================================================================
router:validate:
  extends:
    - .ansible
    - .interruptible
    - .router_changes
  stage: validate
  needs:
    - job: build:ci-image
      optional: true
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/router.yml --check --diff

zwave:validate:
  extends:
    - .ansible
    - .interruptible
    - .zwave_changes
  stage: validate
  needs:
    - job: build:ci-image
      optional: true
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/zwave.yml --check --diff

satellite-2:validate:
  extends:
    - .ansible
    - .interruptible
    - .satellite2_changes
  stage: validate
  needs:
    - job: build:ci-image
      optional: true
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/satellite-2.yml --check --diff

# =============================================================================
# Deploy Stage - DAG-based parallel deployment
# =============================================================================
# Each deploy job only waits for its own validation job, not all validation.
# Uses resource_group to ensure deploys run in order across pipelines.
# NOT interruptible - never cancel mid-deploy.

router:deploy:
  extends:
    - .ansible
    - .router_deploy_rules
  stage: deploy
  resource_group: deploy-router
  needs:
    - job: router:validate
      optional: true
    - job: build:ci-image
      optional: true
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/router.yml

zwave:deploy:
  extends:
    - .ansible
    - .zwave_deploy_rules
  stage: deploy
  resource_group: deploy-zwave
  needs:
    - job: zwave:validate
      optional: true
    - job: build:ci-image
      optional: true
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/zwave.yml

satellite-2:deploy:
  extends:
    - .ansible
    - .satellite2_deploy_rules
  stage: deploy
  resource_group: deploy-satellite-2
  needs:
    - job: satellite-2:validate
      optional: true
    - job: build:ci-image
      optional: true
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/satellite-2.yml
