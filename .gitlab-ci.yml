# =============================================================================
# CI Pipeline - Optimized for Speed
# =============================================================================
# Optimizations:
# - Shallow git clone (GIT_DEPTH: 5)
# - DAG parallelization - all validate jobs run in parallel (needs: [])
# - Path-based rules - jobs only run when relevant files change
# - Interruptible validation - new commits cancel in-progress MR pipelines
# - Aggressive pip/ansible caching with corruption cleanup
#
# Pipeline structure:
#
#   ┌──────────────┬──────────────┐
#   │              │              │
#   router:val  zwave:val  satellite-2:val  (parallel)
#   │              │              │
#   router:deploy zwave:deploy satellite-2:deploy (parallel, main only)
#
# =============================================================================

# =============================================================================
# Workflow Configuration
# =============================================================================
workflow:
  auto_cancel:
    on_new_commit: interruptible

variables:
  GIT_DEPTH: 5
  ANSIBLE_HOST_KEY_CHECKING: "False"
  ANSIBLE_PIPELINING: "True"
  PIP_CACHE_DIR: "/cache/pip"
  ANSIBLE_ROLES_PATH: "/cache/ansible-roles"

# =============================================================================
# Path-based change detection
# =============================================================================

.router_changes:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - ansible/router.yml
        - ansible/inventory.yml
        - ansible/roles/configure-base/**/*
        - ansible/roles/configure-docker/**/*
        - ansible/roles/configure-router-network/**/*
        - ansible/roles/configure-wireguard/**/*
        - ansible/roles/configure-notifications/**/*
        - docker/docker-compose.yml
        - docker/**/*
        - networking/**/*
        - requirements.txt
        - ansible/requirements.yml
        - .gitlab-ci.yml

.zwave_changes:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - ansible/zwave.yml
        - ansible/inventory.yml
        - ansible/roles/configure-zwave/**/*
        - ansible/roles/configure-snapclient/**/*
        - docker/docker-compose-zwave.yml
        - requirements.txt
        - ansible/requirements.yml
        - .gitlab-ci.yml

.satellite2_changes:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - ansible/satellite-2.yml
        - ansible/inventory.yml
        - ansible/roles/configure-satellite/**/*
        - requirements.txt
        - ansible/requirements.yml
        - .gitlab-ci.yml

.router_deploy_rules:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - ansible/router.yml
        - ansible/inventory.yml
        - ansible/roles/configure-base/**/*
        - ansible/roles/configure-docker/**/*
        - ansible/roles/configure-router-network/**/*
        - ansible/roles/configure-wireguard/**/*
        - ansible/roles/configure-notifications/**/*
        - docker/docker-compose.yml
        - docker/**/*
        - networking/**/*

.zwave_deploy_rules:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - ansible/zwave.yml
        - ansible/inventory.yml
        - ansible/roles/configure-zwave/**/*
        - ansible/roles/configure-snapclient/**/*
        - docker/docker-compose-zwave.yml

.satellite2_deploy_rules:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - ansible/satellite-2.yml
        - ansible/inventory.yml
        - ansible/roles/configure-satellite/**/*

# =============================================================================
# Job Templates
# =============================================================================
.interruptible:
  interruptible: true

stages:
  - validate
  - deploy

# =============================================================================
# Base job - shared setup with aggressive caching
# =============================================================================
.ansible:
  image: willhallonline/ansible:latest
  before_script:
    # Setup cache directories
    - mkdir -p /cache/pip /cache/ansible-roles
    # Install Python deps (cached wheels)
    - pip3 install -q --cache-dir /cache/pip -r requirements.txt
    # Clean up corrupted role directories (ansible-galaxy --force doesn't handle this)
    - |
      for d in /cache/ansible-roles/*/; do
        [ -d "$d" ] && [ ! -f "${d}meta/main.yml" ] && [ ! -f "${d}tasks/main.yml" ] && rm -rf "$d" 2>/dev/null
      done
    # Install Ansible roles (cached)
    - ansible-galaxy install -r ansible/requirements.yml -p /cache/ansible-roles --force 2>/dev/null || ansible-galaxy install -r ansible/requirements.yml -p /cache/ansible-roles
    # Setup SSH
    - mkdir -p ~/.ssh
    - cp ansible/known_hosts ~/.ssh/known_hosts
    - echo ${ROUTER_PRIVATE_KEY_BASE64}|base64 -d > tmp && chmod 600 tmp
  cache:
    key: "ansible-deps-v2"
    paths:
      - /cache/pip
      - /cache/ansible-roles
    policy: pull-push

# =============================================================================
# Validation Stage - Parallel execution on MRs
# =============================================================================
router:validate:
  extends:
    - .ansible
    - .interruptible
    - .router_changes
  stage: validate
  needs: []
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/router.yml --check --diff

zwave:validate:
  extends:
    - .ansible
    - .interruptible
    - .zwave_changes
  stage: validate
  needs: []
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/zwave.yml --check --diff

satellite-2:validate:
  extends:
    - .ansible
    - .interruptible
    - .satellite2_changes
  stage: validate
  needs: []
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/satellite-2.yml --check --diff

# =============================================================================
# Deploy Stage - Parallel deployment (main only)
# =============================================================================
router:deploy:
  extends:
    - .ansible
    - .router_deploy_rules
  stage: deploy
  resource_group: deploy-router
  needs:
    - job: router:validate
      optional: true
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/router.yml

zwave:deploy:
  extends:
    - .ansible
    - .zwave_deploy_rules
  stage: deploy
  resource_group: deploy-zwave
  needs:
    - job: zwave:validate
      optional: true
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/zwave.yml

satellite-2:deploy:
  extends:
    - .ansible
    - .satellite2_deploy_rules
  stage: deploy
  resource_group: deploy-satellite-2
  needs:
    - job: satellite-2:validate
      optional: true
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/satellite-2.yml
