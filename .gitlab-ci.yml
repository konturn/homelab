# =============================================================================
# Workflow Configuration
# =============================================================================
workflow:
  auto_cancel:
    on_new_commit: interruptible

variables:
  PIP_CACHE_DIR: "/cache/pip"
  ANSIBLE_ROLES_PATH: "/cache/ansible-roles"

# =============================================================================
# Job Templates
# =============================================================================
.ansible:
  image: willhallonline/ansible:latest
  before_script:
    - mkdir -p /cache/pip /cache/ansible-roles
    - pip3 install --cache-dir /cache/pip -r requirements.txt
    - ansible-galaxy install -r ansible/requirements.yml -p /cache/ansible-roles
    - echo ${ROUTER_PRIVATE_KEY_BASE64}|base64 -d > tmp
    - chmod 600 tmp
    - mkdir ~/.ssh
    - cp ansible/known_hosts ~/.ssh/known_hosts

.interruptible:
  interruptible: true

stages:
  - validate
  - build
  - deploy

# =============================================================================
# Validation (MRs) - Dry run only, no actual changes
# =============================================================================

router:validate:
  extends:
    - .ansible
    - .interruptible
  stage: validate
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/router.yml --check --diff
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

zwave:validate:
  extends:
    - .ansible
    - .interruptible
  stage: validate
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/zwave.yml --check --diff
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

satellite-2:validate:
  extends:
    - .ansible
    - .interruptible
  stage: validate
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/satellite-2.yml --check --diff
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# =============================================================================
# Build (main branch only) - Build container images
# =============================================================================

moltbot:build:
  stage: build
  tags:
    - images  # Use runner with docker socket mounted
  image: docker:24
  before_script:
    - echo "$DOCKER_REGISTRY_KEY" | docker login -u docker --password-stdin registry.lab.nkontur.com
  script:
    - docker build -t registry.lab.nkontur.com/moltbot-gateway:latest -t registry.lab.nkontur.com/moltbot-gateway:$CI_COMMIT_SHORT_SHA docker/moltbot/
    - docker push registry.lab.nkontur.com/moltbot-gateway:latest
    - docker push registry.lab.nkontur.com/moltbot-gateway:$CI_COMMIT_SHORT_SHA
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - docker/moltbot/**/*

# =============================================================================
# Deploy (main branch only) - Actual deployment
# NOT interruptible - never cancel mid-deploy
# Uses resource_group to ensure deploys run in order across pipelines
# =============================================================================

.deploy:
  extends: .ansible
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

router:deploy:
  extends: .deploy
  resource_group: deploy-router
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/router.yml

zwave:deploy:
  extends: .deploy
  resource_group: deploy-zwave
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/zwave.yml

satellite-2:deploy:
  extends: .deploy
  resource_group: deploy-satellite-2
  script:
    - ansible-playbook -i ansible/inventory.yml -u root --private-key=tmp ansible/satellite-2.yml
