- name: Run Netplan config
  ansible.builtin.include_role:
    name: mrlesmithjr.netplan
  vars: 
    netplan_enabled: true
    netplan_config_file: /etc/netplan/config.yaml
    netplan_renderer: networkd
    netplan_configuration: "{{ lookup('file', lookup('env', 'CI_PROJECT_DIR') + '/networking/netplan/config.yaml') }}"

- name: Template the iptables rules file
  ansible.builtin.template:
    src: "{{ lookup('file', lookup('env', 'CI_PROJECT_DIR') + '/networking/iptables/rules.v4') }}"
    dest: /etc/iptables/rules.v4
    owner: root
    group: root
    mode: '0640'

- name: Restore iptables rules
  ansible.builtin.command: /sbin/iptables-restore < /etc/iptables/rules.v4
  become: yes

