# Extract individual fields from a Vault KV v2 response into Ansible facts.
# Called from main.yml for each Vault path response.
#
# All values are trimmed to strip trailing newlines that Vault KV v2 may
# include.  Without this, secrets break cron jobs (Ansible cron module rejects
# embedded newlines), HTTP headers, and CLI arguments.

- name: "Set facts from {{ _vault_response.item.path }}"
  ansible.builtin.set_fact:
    "{{ item.key }}": "{{ _vault_response.json.data.data[item.value] | trim }}"
  loop: "{{ _vault_response.item.fields | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  no_log: true
