# =============================================================================
# Role: claude-user
# =============================================================================
# Creates a restricted 'claude' user for AI agent SSH access via Vault-signed
# certificates. The user runs rbash with a curated set of read-only commands.
# SSH trust is established via Vault's SSH CA public key.
# =============================================================================

- name: Create claude group
  group:
    name: "{{ claude_user_group }}"
    state: present

- name: Create claude user with restricted shell
  user:
    name: "{{ claude_user_name }}"
    group: "{{ claude_user_group }}"
    shell: /bin/rbash
    home: "/home/{{ claude_user_name }}"
    create_home: yes
    comment: "Restricted read-only user for AI agent SSH access"

- name: Set claude home directory permissions
  file:
    path: "/home/{{ claude_user_name }}"
    mode: '0700'
    owner: "{{ claude_user_name }}"
    group: "{{ claude_user_group }}"

- name: Create restricted PATH bin directory
  file:
    path: "/home/{{ claude_user_name }}/bin"
    state: directory
    mode: '0755'
    owner: "{{ claude_user_name }}"
    group: "{{ claude_user_group }}"

- name: Symlink allowed commands into restricted PATH
  file:
    src: "{{ item.src }}"
    dest: "/home/{{ claude_user_name }}/bin/{{ item.name }}"
    state: link
  loop:
    - { src: /usr/bin/cat, name: cat }
    - { src: /usr/bin/ls, name: ls }
    - { src: /usr/bin/head, name: head }
    - { src: /usr/bin/tail, name: tail }
    - { src: /usr/bin/grep, name: grep }
    - { src: /usr/bin/find, name: find }
    - { src: /usr/bin/df, name: df }
    - { src: /usr/bin/du, name: du }
    - { src: /usr/bin/ps, name: ps }
    - { src: /usr/bin/uptime, name: uptime }
    - { src: /usr/bin/free, name: free }
    - { src: /usr/bin/id, name: id }
    - { src: /usr/bin/whoami, name: whoami }
    - { src: /usr/bin/hostname, name: hostname }
    - { src: /usr/bin/date, name: date }
    - { src: /usr/bin/wc, name: wc }
    - { src: /usr/bin/sort, name: sort }
    - { src: /usr/bin/uniq, name: uniq }
    - { src: /usr/bin/less, name: less }
    - { src: /usr/bin/stat, name: stat }
    - { src: /usr/bin/file, name: file }
    - { src: /usr/bin/journalctl, name: journalctl }
    - { src: /usr/bin/systemctl, name: systemctl }
    - { src: /usr/bin/ip, name: ip }
    - { src: /usr/bin/ss, name: ss }
    - { src: /usr/bin/dig, name: dig }
    - { src: /usr/bin/ping, name: ping }
    - { src: /usr/bin/traceroute, name: traceroute }
    - { src: /usr/bin/docker, name: docker }
  ignore_errors: yes  # Some binaries may not exist on all hosts

- name: Configure restricted .bashrc
  copy:
    dest: "/home/{{ claude_user_name }}/.bashrc"
    owner: "{{ claude_user_name }}"
    group: "{{ claude_user_group }}"
    mode: '0644'
    content: |
      # Restricted shell configuration
      export PATH=/home/{{ claude_user_name }}/bin
      export HISTFILE=/home/{{ claude_user_name }}/.bash_history
      export HISTSIZE=1000
      readonly PATH
      # No cd allowed in rbash by default
      echo "Restricted shell. Commands: cat ls head tail grep find df du ps journalctl systemctl ip ss dig docker"

- name: Create .profile
  copy:
    dest: "/home/{{ claude_user_name }}/.profile"
    owner: "{{ claude_user_name }}"
    group: "{{ claude_user_group }}"
    mode: '0644'
    content: |
      if [ -f ~/.bashrc ]; then
        . ~/.bashrc
      fi

- name: Deny cron access for claude user
  lineinfile:
    path: /etc/cron.deny
    line: "{{ claude_user_name }}"
    create: yes

- name: Deny at access for claude user
  lineinfile:
    path: /etc/at.deny
    line: "{{ claude_user_name }}"
    create: yes

- name: Add claude user to docker group
  user:
    name: "{{ claude_user_name }}"
    groups: docker
    append: yes
  when: claude_docker_access | default(false)

- name: Ensure claude user is NOT in docker group
  user:
    name: "{{ claude_user_name }}"
    groups: []
    append: no
  when: not (claude_docker_access | default(false))

- name: Ensure sensitive directories are not world-readable
  file:
    path: "{{ item }}"
    mode: '0700'
  loop:
    - /root
  ignore_errors: yes

- name: Ensure sensitive files are not world-readable
  file:
    path: "{{ item }}"
    mode: '0600'
  loop:
    - /etc/shadow
    - /etc/gshadow
  ignore_errors: yes

- name: Disable root login with password
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PermitRootLogin"
    line: "PermitRootLogin prohibit-password"
  notify: restart sshd

- name: Disable password authentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PasswordAuthentication"
    line: "PasswordAuthentication no"
  notify: restart sshd

- name: Validate SSH CA key is not empty
  ansible.builtin.assert:
    that:
      - vault_ssh_ca_public_key | length > 0
    fail_msg: "vault_ssh_ca_public_key is empty — refusing to write empty CA file"
  when: fetch_ssh_ca_key | default(false) | bool

- name: Configure SSH to trust Vault CA
  copy:
    dest: /etc/ssh/trusted-user-ca-keys.pem
    content: "{{ vault_ssh_ca_public_key }}"
    mode: '0644'
  when: vault_ssh_ca_public_key | length > 0
  notify: restart sshd

- name: Add TrustedUserCAKeys to sshd_config
  lineinfile:
    path: /etc/ssh/sshd_config
    line: "TrustedUserCAKeys /etc/ssh/trusted-user-ca-keys.pem"
    regexp: "^TrustedUserCAKeys"
  notify: restart sshd

- name: Create AuthorizedPrincipals directory
  file:
    path: /etc/ssh/auth_principals
    state: directory
    mode: '0755'

- name: Configure AuthorizedPrincipals for claude user
  copy:
    dest: "/etc/ssh/auth_principals/{{ claude_user_name }}"
    content: "{{ claude_user_principal }}\n"
    mode: '0644'
  notify: restart sshd

- name: Add AuthorizedPrincipalsFile to sshd_config
  lineinfile:
    path: /etc/ssh/sshd_config
    line: "AuthorizedPrincipalsFile /etc/ssh/auth_principals/%u"
    regexp: "^AuthorizedPrincipalsFile"
  notify: restart sshd

# =============================================================================
# Elevated user (claude-elevated) — full shell with sudo, gated by JIT T2
# =============================================================================

- name: Create claude-elevated group
  group:
    name: "{{ claude_elevated_user_group }}"
    state: present
  when: claude_elevated_access | default(false)

- name: Create claude-elevated user with full shell
  user:
    name: "{{ claude_elevated_user_name }}"
    group: "{{ claude_elevated_user_group }}"
    shell: /bin/bash
    home: "/home/{{ claude_elevated_user_name }}"
    create_home: yes
    comment: "Elevated AI agent SSH access with sudo"
  when: claude_elevated_access | default(false)

- name: Grant claude-elevated passwordless sudo
  copy:
    dest: "/etc/sudoers.d/{{ claude_elevated_user_name }}"
    content: "{{ claude_elevated_user_name }} ALL=(ALL) NOPASSWD: ALL\n"
    mode: '0440'
    validate: 'visudo -cf %s'
  when: claude_elevated_access | default(false)

- name: Configure AuthorizedPrincipals for claude-elevated user
  copy:
    dest: "/etc/ssh/auth_principals/{{ claude_elevated_user_name }}"
    content: "{{ claude_elevated_user_principal }}\n"
    mode: '0644'
  notify: restart sshd
  when: claude_elevated_access | default(false)
