- name: ensure required pip-packages are installed
  pip:
    name:
      - docker
      - PyYAML
      - docker-compose

- name: Template out compose file to ansible state directory on host
  ansible.builtin.template:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/docker-compose.yml' }}"
    dest: "{{ docker_persistent_data_path + '/ansible_state/docker-compose.yml' }}"
    owner: root
    group: root
    mode: '0755'

- name: Create and start Docker services
  community.docker.docker_compose:
    project_name: docker
    project_src: "{{ docker_persistent_data_path }}/ansible_state"
    state: present

- name: Template out compose file to docker directory on host
  ansible.builtin.template:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/nextcloud/config.php' }}"
    dest: "{{ docker_persistent_data_path + '/nextcloud/config/config.php' }}"
    owner: www-data
    group: www-data
    mode: '0644'
  register: nextcloud

- name: Restart nextcloud if config change
  community.docker.docker_container:
    name: nextcloud
    restart: yes
  when: nextcloud.changed

- name: Template out pihole custom list
  ansible.builtin.template:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/pihole/custom.list' }}"
    dest: "{{ docker_persistent_data_path + '/pihole/conf/custom.list' }}"
    owner: root
    group: root
    mode: '0755'
  register: pihole_list

- name: Template out pihole custom dnsmasq config
  ansible.builtin.template:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/pihole/custom.conf' }}"
    dest: "{{ docker_persistent_data_path + '/pihole/dnsmasq/custom.conf' }}"
    owner: root
    group: root
    mode: '0755'
  register: pihole_dnsmasq

- name: Restart pihole if config change
  community.docker.docker_container:
    name: pihole
    restart: yes
  when: pihole_list.changed or pihole_dnsmasq.changed

- name: Synchronize template files for nginx script generation into ansible workspace on host
  ansible.posix.synchronize:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/nginx/' }}"
    dest: "{{ docker_persistent_data_path + '/ansible_state' }}"
  changed_when: false

- name: Execute Python script to generate lab_nginx custom config files
  shell:
    cmd: "/usr/bin/python3 {{ docker_persistent_data_path }}/ansible_state/generate-configs.py --workspace-path {{ docker_persistent_data_path }}/ansible_state --network internal --stream-config-path {{ docker_persistent_data_path }}/lab_nginx/conf/conf.d/stream/stream.conf"
  register: lab_nginx
  changed_when: "'Nginx configuration changed' in lab_nginx.stdout"

- name: Restart lab_nginx if config change
  community.docker.docker_container:
    name: lab_nginx
    restart: yes
  when: lab_nginx.changed

- name: Execute Python script to generate nginx custom config files
  shell:
    cmd: "/usr/bin/python3 {{ docker_persistent_data_path }}/ansible_state/generate-configs.py --workspace-path {{ docker_persistent_data_path }}/ansible_state --network external --stream-config-path {{ docker_persistent_data_path }}/nginx/conf/conf.d/stream/stream.conf"
  register: nginx
  changed_when: "'Nginx configuration changed' in nginx.stdout"

- name: Restart nginx if config change
  community.docker.docker_container:
    name: nginx
    restart: yes
  when: nginx.changed
