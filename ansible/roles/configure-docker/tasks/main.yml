#- name: install python-setuptools
#  package:
#    name: python-setuptools
#    state: present
#  delegate_to: localhost

- name: ensure required pip-packages are installed within docker image
  pip:
    name:
      - docker
      - PyYAML
      - docker-compose
  delegate_to: localhost

- name: Log in to private docker repo
  docker_login:
    username: docker
    password: "{{ lookup('env', 'DOCKER_REGISTRY_KEY') }}"
    registry_url: "https://registry.lab.nkontur.com"

- name: Template out compose file to ansible state directory on host
  ansible.builtin.template:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/docker-compose.yml' }}"
    dest: "{{ docker_persistent_data_path + '/ansible_state/docker-compose.yml' }}"
    owner: root
    group: root
    mode: '0700'

- name: Create and start Docker services
  community.docker.docker_compose:
    project_name: docker
    project_src: "{{ docker_persistent_data_path }}/ansible_state"
    state: present

- name: Template out homeassistant conf file to docker directory on host
  ansible.builtin.template:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/homeassistant/configuration.yaml' }}"
    dest: "{{ docker_persistent_data_path + '/homeassistant/configuration.yaml' }}"
    owner: root
    group: root
    mode: '0644'
  register: homeassistant

- name: Restart homeassistant if config change
  community.docker.docker_container:
    name: homeassistant
    restart: yes
  when: homeassistant.changed

- name: Template out homeassistant conf file to docker directory on host
  ansible.builtin.template:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/frigate/config.yml' }}"
    dest: "{{ docker_persistent_data_path + '/frigate/config.yml' }}"
    owner: root
    group: root
    mode: '0644'
  register: frigate

- name: Restart frigate if config change
  community.docker.docker_container:
    name: frigate
    restart: yes
  when: frigate.changed

- name: Template out nextcloud conf file to docker directory on host
  ansible.builtin.template:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/nextcloud/config.php' }}"
    dest: "{{ docker_persistent_data_path + '/nextcloud/config/config.php' }}"
    owner: www-data
    group: www-data
    mode: '0644'
  register: nextcloud

- name: Restart nextcloud if config change
  community.docker.docker_container:
    name: nextcloud
    restart: yes
  when: nextcloud.changed

- name: Sets up base cronjob for nextcloud
  ansible.builtin.cron:
    name: "Nextcloud base cronjob"
    minute: "*/5"
    job: "docker exec -t -u www-data nextcloud php -f /var/www/html/cron.php"

- name: Sets up periodic file scan cronjob for nextcloud
  ansible.builtin.cron:
    name: "Nextcloud file scan cronjob"
    minute: "0"
    hour: "2"
    weekday: "0"
    job: "docker exec -u www-data nextcloud php occ files:scan --all"

- name: Sets up perodic plex chown
  ansible.builtin.cron:
    name: "Plex dir chown"
    hour: 0
    job: "chown -R konoahko:konoahko /mpool/plex"

- name: Template out pihole custom list
  ansible.builtin.template:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/pihole/custom.list' }}"
    dest: "{{ docker_persistent_data_path + '/pihole/conf/custom.list' }}"
    owner: root
    group: root
    mode: '0755'
  register: pihole_list

- name: Template out pihole custom dnsmasq config
  ansible.builtin.template:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/pihole/custom.conf' }}"
    dest: "{{ docker_persistent_data_path + '/pihole/dnsmasq/custom.conf' }}"
    owner: root
    group: root
    mode: '0755'
  register: pihole_dnsmasq

- name: Restart pihole if config change
  community.docker.docker_container:
    name: pihole
    restart: yes
  when: pihole_list.changed or pihole_dnsmasq.changed

- name: Template out compose file to ansible state directory within container
  ansible.builtin.template:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') + '/docker/docker-compose.yml' }}"
    dest: "{{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx"
    owner: root
    group: root
    mode: '0755'
  changed_when: false
  delegate_to: localhost

- name: Execute Python script to generate lab_nginx custom config files
  shell:
    cmd: "/usr/bin/python3 {{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/generate-configs.py --workspace-path {{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx --network internal"
  delegate_to: localhost
  changed_when: false

- name: Copy base configuration file
  ansible.builtin.copy:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/nginx.conf"
    dest: "{{ docker_persistent_data_path }}/lab_nginx/conf/nginx.conf"
    owner: root
    group: root
    mode: '0644'
  register: lab_nginx_base

- name: Copy lab_nginx stream configuration file
  ansible.builtin.copy:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/stream.conf"
    dest: "{{ docker_persistent_data_path }}/lab_nginx/conf/conf.d/stream.conf"
    owner: root
    group: root
    mode: '0644'
  register: lab_nginx_stream

- name: Copy lab_nginx http configuration file
  ansible.builtin.copy:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/http.conf"
    dest: "{{ docker_persistent_data_path }}/lab_nginx/conf/conf.d/http.conf"
    owner: root
    group: root
    mode: '0644'
  register: lab_nginx_http

- name: Restart lab_nginx if config change
  community.docker.docker_container:
    name: lab_nginx
    restart: yes
  when: lab_nginx_base.changed or lab_nginx_stream.changed or lab_nginx_http.changed

- name: Execute Python script to generate nginx custom config files
  shell:
    cmd: "/usr/bin/python3 {{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/generate-configs.py --workspace-path {{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx --network external"
  delegate_to: localhost
  changed_when: false

- name: Copy base configuration file
  ansible.builtin.copy:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/nginx.conf"
    dest: "{{ docker_persistent_data_path }}/nginx/conf/nginx.conf"
    owner: root
    group: root
    mode: '0644'
  register: nginx_base

- name: Copy nginx stream configuration file
  ansible.builtin.copy:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/stream.conf"
    dest: "{{ docker_persistent_data_path }}/nginx/conf/conf.d/stream.conf"
    owner: root
    group: root
    mode: '0644'
  register: nginx_stream

- name: Copy nginx http configuration file
  ansible.builtin.copy:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/http.conf"
    dest: "{{ docker_persistent_data_path }}/nginx/conf/conf.d/http.conf"
    owner: root
    group: root
    mode: '0644'
  register: nginx_http

- name: Restart nginx if config change
  community.docker.docker_container:
    name: nginx
    restart: yes
  when: nginx_base.changed or nginx_stream.changed or nginx_http.changed

- name: Execute Python script to generate iot_nginx custom config files
  shell:
    cmd: "/usr/bin/python3 {{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/generate-configs.py --workspace-path {{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx --network iot"
  delegate_to: localhost
  changed_when: false

- name: Copy base configuration file
  ansible.builtin.copy:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/nginx.conf"
    dest: "{{ docker_persistent_data_path }}/iot_nginx/conf/nginx.conf"
    owner: root
    group: root
    mode: '0644'
  register: iot_nginx_base

- name: Copy iot_nginx stream configuration file
  ansible.builtin.copy:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/stream.conf"
    dest: "{{ docker_persistent_data_path }}/iot_nginx/conf/conf.d/stream.conf"
    owner: root
    group: root
    mode: '0644'
  register: iot_nginx_stream

- name: Copy iot_nginx http configuration file
  ansible.builtin.copy:
    src: "{{ lookup('env', 'CI_PROJECT_DIR') }}/docker/nginx/http.conf"
    dest: "{{ docker_persistent_data_path }}/iot_nginx/conf/conf.d/http.conf"
    owner: root
    group: root
    mode: '0644'
  register: iot_nginx_http

- name: Restart iot_nginx if config change
  community.docker.docker_container:
    name: nginx
    restart: yes
  when: iot_nginx_base.changed or iot_nginx_stream.changed or iot_nginx_http.changed
