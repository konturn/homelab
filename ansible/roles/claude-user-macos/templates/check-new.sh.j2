#!/bin/bash
# Check for new iMessages on Mac Mini since last check
# Runs via SSH as claude, uses sudo to query konoahko's chat.db
# Outputs JSON array of new messages
# Stores last-check timestamp in ~/.imessage-last-check

set -euo pipefail

LAST_CHECK_FILE="$HOME/.imessage-last-check"
DB="/Users/konoahko/Library/Messages/chat.db"

# Get last check timestamp (macOS CoreData epoch: seconds since 2001-01-01)
# Default to 5 minutes ago if no prior check
if [ -f "$LAST_CHECK_FILE" ]; then
  LAST_TS=$(cat "$LAST_CHECK_FILE")
else
  # 5 minutes ago in CoreData nanoseconds
  LAST_TS=$(python3 -c "
import time
# CoreData epoch offset: 978307200 seconds between Unix epoch and 2001-01-01
now_unix = time.time()
core_data_seconds = now_unix - 978307200
five_min_ago = (core_data_seconds - 300) * 1000000000
print(int(five_min_ago))
")
fi

# Query for new messages NOT from me, newer than last check
MESSAGES=$(sudo -n -u konoahko /usr/bin/sqlite3 -json "$DB" "
SELECT
  m.ROWID as id,
  m.text as text,
  m.date as date,
  h.id as sender,
  m.is_from_me as is_from_me,
  c.chat_identifier as chat_id,
  c.display_name as chat_name
FROM message m
LEFT JOIN handle h ON m.handle_id = h.ROWID
LEFT JOIN chat_message_join cmj ON m.ROWID = cmj.message_id
LEFT JOIN chat c ON cmj.chat_id = c.ROWID
WHERE m.date > $LAST_TS
  AND m.is_from_me = 0
  AND m.text IS NOT NULL
ORDER BY m.date ASC;
" 2>/dev/null || echo "[]")

# Update last check to now
python3 -c "
import time
now_unix = time.time()
core_data_ns = int((now_unix - 978307200) * 1000000000)
print(core_data_ns)
" > "$LAST_CHECK_FILE"

echo "$MESSAGES"
