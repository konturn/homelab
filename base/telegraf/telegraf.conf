[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  
  gather_services = false

  container_name_include = []
  container_name_exclude = []

  timeout = "5s"

  docker_label_include = []
  docker_label_exclude = []

  perdevice_include = ["cpu", "blkio", "network"]

[[inputs.snmp]]
  ## Agent addresses to retrieve values from.
  ##   example: agents = ["udp://127.0.0.1:161"]
  ##            agents = ["tcp://127.0.0.1:161"]
  agents = ["udp://ups.lab.nkontur.com:161"]

  ## Timeout for each request.
  timeout = "5s"

  ## SNMP version; can be 1, 2, or 3.
  version = 3

  ## SNMP community string.
  community = "public"

  ## Agent host tag - use "source" for consistency across plugins
  ## (deprecated default "agent_host" in Telegraf 1.29+)
  agent_host_tag = "source"

  ## Number of retries to attempt.
  retries = 3

  ## The GETBULK max-repetitions parameter.
  # max_repetitions = 10

  ## SNMPv3 authentication and encryption options.
  ##
  ## Security Name.
   sec_name = "apc1"
  ## Authentication protocol; one of "MD5", "SHA", or "".
  auth_protocol = "MD5"
  ## Authentication password.
   auth_password = "{{ vault_snmp_password | default(lookup('env', 'SNMP_PASSWORD')) }}"
  ## Security Level; one of "noAuthNoPriv", "authNoPriv", or "authPriv".
  sec_level = "authPriv"
  ## Context Name.
  # context_name = ""
  ## Privacy protocol used for encrypted messages; one of "DES", "AES", "AES192", "AES192C", "AES256", "AES256C" or "".
   priv_protocol = "AES"
  ## Privacy password used for encrypted messages.
  priv_password = "{{ vault_snmp_password | default(lookup('env', 'SNMP_PASSWORD')) }}"

  ## Add fields and tables defining the variables you wish to collect.  This
  ## example collects the system uptime and interface variables.  Reference the
  ## full plugin documentation for configuration details.
  [[inputs.snmp.field]]
    oid = "UPS-MIB::upsOutputCurrent.1"
    name = "consumption"
  [[inputs.snmp.field]]
    oid = "UPS-MIB::upsBatteryTemperature.0"
    name = "temperature"
  [[inputs.snmp.field]]
    oid = "UPS-MIB::upsOutputPercentLoad.1"
    name = "load"
  [[inputs.snmp.field]]
    oid = "UPS-MIB::upsOutputVoltage.1"
    name = "voltage"
  [[inputs.snmp.field]]
    oid = "UPS-MIB::upsEstimatedMinutesRemaining.0"
    name = "minutes"
  [[inputs.snmp.field]]
    oid = "UPS-MIB::upsEstimatedChargeRemaining.0"
    name = "percent_charge"
  [[inputs.snmp.field]]
    oid = "UPS-MIB::upsBatteryStatus.0"
    name = "status"
  [[inputs.snmp.field]]
    oid = "UPS-MIB::upsSecondsOnBattery.0"
    name = "batterySeconds"

[[inputs.ipmi_sensor]]
        path = "/usr/bin/ipmitool"
        servers = ["ADMIN:{{ vault_ipmi_password | default(lookup('env', 'IPMI_PASSWORD')) }}@lan(ipmi.lab.nkontur.com)"]
        interval = "30s"
        timeout = "20s"
[[inputs.cpu]]
    percpu = true
    totalcpu = true
    collect_cpu_time = false
    report_active = true
[[inputs.disk]]
    ignore_fs = ["tmpfs", "devtmpfs", "devfs"]
[[inputs.diskio]]
[[inputs.mem]]
[[inputs.net]]
[[inputs.system]]
[[inputs.swap]]
[[inputs.netstat]]
[[inputs.processes]]
[[inputs.kernel]]
[[inputs.ping]]
  ## Use native method for improved performance (recommended over default "exec")
  method = "native"
  interval = "60s"
  urls = ["208.67.222.222", "208.67.220.220", "amazon.com", "github.com"]
  count = 4
  ping_interval = 1.0
  timeout = 2.0
#[[inputs.logparser]]
#  files = ["/var/log/nginx/access.log"]
#  from_beginning = true
#  name_override = "nginx_access_log"
#  [inputs.logparser.grok]
#    patterns = ["%{COMBINED_LOG_FORMAT}"]

# ============================================================================
# SMART Disk Health - Predict failures before they happen
# ============================================================================
[[inputs.smart]]
  path_smartctl = "/usr/sbin/smartctl"
  path_nvme = "/usr/sbin/nvme"
  use_sudo = true
  attributes = true
  interval = "5m"

# ============================================================================
# Hardware Sensors - Temps, fans, voltages (requires lm-sensors)
# ============================================================================
[[inputs.sensors]]

# ============================================================================
# Certificate Expiry - Never get surprised by cert issues
# ============================================================================
[[inputs.x509_cert]]
  sources = [
    "https://grafana.lab.nkontur.com:443",
    "https://gitlab.lab.nkontur.com:443",
    "https://nextcloud.nkontur.com:443",
    "https://plex.nkontur.com:443"
  ]
  interval = "6h"
  timeout = "30s"

# ============================================================================
# DNS Health - Verify DNS resolution is working
# ============================================================================
[[inputs.dns_query]]
  servers = ["127.0.0.1"]
  domains = ["google.com", "cloudflare.com", "github.com"]
  record_type = "A"
  timeout = "5s"
  interval = "60s"

# ============================================================================
# Systemd Services - Track service status
# ============================================================================
[[inputs.systemd_units]]
  unittype = "service"
  pattern = "docker* ssh* telegraf* nginx*"
  timeout = "5s"

[[outputs.influxdb_v2]]
 ## The URLs of the InfluxDB cluster nodes.
 ##
 ## Multiple URLs can be specified for a single cluster, only ONE of the
 ## urls will be written to each interval.
 ## urls exp: http://127.0.0.1:9999
 ## Use internal Docker network IP for reliable local writes
 urls = ["http://{{ influxdb_ip }}:8086"]

 ## Token for authentication.
 token = "{{ vault_influxdb_telegraf_token | default(lookup('env', 'INFLUXDB_TELEGRAF_TOKEN')) }}"

 ## Organization is the name of the organization you wish to write to; must exist.
 organization = "homelab"

 ## Destination bucket to write into.
 bucket = "metrics"

